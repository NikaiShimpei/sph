<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sophian Quiz Chat</title>
    <!-- Google Fonts: Mplus 1p -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <!-- Dify APIè¨­å®šï¼ˆæ©Ÿå¯†æƒ…å ±ï¼‰ -->
    <script src="../config.js"></script>
    <style>
        /* --- ä¸Šæ™ºå¤§å­¦ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼å®šç¾© --- */
        :root {
            --sophia-claret: #9E1B32; /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼ˆã‚¨ãƒ³ã‚¸ï¼‰ */
            --urban-navy: #1C2538;    /* ã‚µãƒãƒ¼ãƒˆã‚«ãƒ©ãƒ¼ï¼ˆç´ºï¼‰ */
            --urban-gray-dark: #606875; /* ã‚µãƒãƒ¼ãƒˆã‚«ãƒ©ãƒ¼ï¼ˆæ¿ƒç°ï¼‰ */
            --urban-gray-light: #95A0AB; /* ã‚µãƒãƒ¼ãƒˆã‚«ãƒ©ãƒ¼ï¼ˆè–„ç°ï¼‰ */
            --bg-color: #F5F6F8;      /* èƒŒæ™¯è‰²ï¼ˆè–„ã„ã‚°ãƒ¬ãƒ¼ï¼‰ */
        }

        /* --- åŸºæœ¬è¨­å®š --- */
        body { 
            font-family: "M PLUS 1p", "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; 
            background-image: url('assets/1gokan.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            color: var(--urban-navy);
            position: relative;
            animation: backgroundZoom 20s ease-in-out infinite;
        }

        @keyframes backgroundZoom {
            0%, 100% {
                background-size: 100% auto;
            }
            50% {
                background-size: 110% auto;
            }
        }

        /* --- éŸ³æ¥½ãƒœã‚¿ãƒ³ --- */
        #music-toggle {
            position: fixed;
            top: 2vh;
            left: 2vw;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        #music-toggle:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        #music-toggle.muted {
            opacity: 0.5;
        }

        /* --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠï¼ˆå·¦ä¸Šã«é…ç½®ï¼‰ --- */
        #character-container {
            position: fixed;
            top: 80px;
            left: -150px;
            width: 520px;
            height: auto;
            z-index: 100;
            pointer-events: none;
        }

        #character-container img {
            width: 100%;
            height: auto;
        }
        
        /* --- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ --- */
        #chat-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px 20px 100px 50px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            background: transparent;
        }
        
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .message { 
            max-width: 90%; 
            padding: 30px 40px; 
            border-radius: 24px; 
            font-size: clamp(36px, 4.5vw, 54px);
            line-height: 2.0; 
            position: relative; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå³å´ï¼‰ */
        .message.user { 
            align-self: flex-end; 
            background-color: var(--urban-navy); 
            color: white; 
            border-bottom-right-radius: 4px; 
            font-size: clamp(36px, 4.5vw, 54px);
        }

        /* ãƒœãƒƒãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå·¦å´ï¼‰ */
        .message.bot { 
            align-self: flex-start; 
            background-color: rgba(255, 255, 255, 0.95); 
            color: var(--urban-navy); 
            border-bottom-left-radius: 4px; 
            display: flex; 
            align-items: flex-start; 
            gap: 12px; 
            border: none;
            margin-left: 200px;
            max-width: 60%;
            min-height: auto;
            padding: 30px 50px;
            position: relative;
        }

        /* ãƒœãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¹ãå‡ºã—ï¼ˆCSSã§ä½œæˆï¼‰ */
        .message.bot::before {
            content: '';
            position: absolute;
            left: -20px;
            bottom: 30px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 20px 20px 0 0;
            border-color: rgba(255, 255, 255, 0.95) transparent transparent transparent;
        }

        .message.bot .message-text {
            font-size: clamp(28.5px, 3.6vw, 43.5px);
            line-height: 1.8;
            flex: 1;
        }
        
        /* ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .avatar { 
            width: 44px; 
            height: 44px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 2px solid var(--sophia-claret); 
            flex-shrink: 0;
        }

        /* ã‚¯ã‚¤ã‚ºé–‹å§‹ã‚«ãƒ¼ãƒ‰ï¼ˆãƒãƒ£ãƒƒãƒˆå†…ï¼‰ */
        .quiz-card { 
            background: #fff; 
            border-left: 5px solid var(--sophia-claret); 
            padding: 15px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.2s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            margin-top: 5px;
        }
        .quiz-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(158, 27, 50, 0.15); 
        }
        .quiz-card h3 { 
            margin: 0 0 8px 0; 
            color: var(--sophia-claret); 
            font-size: 1.1em;
        }
        .quiz-card p {
            margin: 0 0 15px 0;
            color: var(--urban-gray-dark);
            font-size: 0.9em;
        }
        .quiz-card button { 
            background: var(--sophia-claret); 
            color: white; 
            border: none; 
            padding: 8px 25px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 0.9em;
            transition: background 0.2s;
        }
        .quiz-card button:hover {
            background-color: #7a1526;
        }

        /* --- å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆå³ä¸‹ã«é…ç½®ï¼‰ --- */
        #input-area { 
            position: fixed;
            bottom: 0;
            right: 0;
            padding: 7px 16px; 
            background: white; 
            display: flex; 
            gap: 8px; 
            border-top: 1px solid #e0e0e0; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
            max-width: 1200px;
            min-width: 600px;
            z-index: 200;
        }
        input { 
            flex: 2; 
            padding: 6px 16px; 
            font-size: 14px; 
            border: 2px solid #e0e0e0; 
            border-radius: 30px; 
            outline: none; 
            transition: border-color 0.2s;
            color: var(--urban-navy);
        }
        input:focus {
            border-color: var(--sophia-claret);
        }
        #send-btn { 
            background-color: var(--sophia-claret); 
            color: white; 
            border: none; 
            padding: 0 30px; 
            border-radius: 30px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 14px;
            transition: background-color 0.2s;
        }
        #send-btn:hover {
            background-color: #7a1526;
        }

        /* --- å…¨ç”»é¢ã‚¯ã‚¤ã‚ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚¯ã‚¤ã‚ºãƒŸãƒªã‚ªãƒã‚¢é¢¨ã€16:9æœ€é©åŒ–ï¼‰ --- */
        #quiz-overlay {
            display: none; /* æœ€åˆã¯éš ã™ */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2d0a15 0%, #460117 50%, #6f0125 100%);
            color: white;
            flex-direction: column; align-items: center; justify-content: flex-start; /* flex-startã«å¤‰æ›´ */
            z-index: 1000; padding: 2vh 3vw; box-sizing: border-box;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
            overflow-x: hidden; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ç„¡åŠ¹åŒ– */
        }
        
        /* 16:9ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã®æœ€é©åŒ– */
        @media (aspect-ratio: 16/9), (min-aspect-ratio: 16/9) {
            #quiz-overlay {
                padding: 1.5vh 4vw;
            }
        }
        #quiz-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(180, 20, 60, 0.4) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulseGlow 3s ease-in-out infinite;
        }
        #quiz-overlay::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                url('assets/slphialogo_color.png'),
                radial-gradient(circle at 20% 30%, rgba(180, 20, 60, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(111, 1, 37, 0.2) 0%, transparent 50%),
                linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.02) 50%, transparent 70%);
            background-size: 
                80% auto, /* ãƒ­ã‚´ã‚’é©åˆ‡ãªã‚µã‚¤ã‚ºã«ç¸®å°ï¼ˆç”»åƒå…¨ä½“ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ï¼‰ */
                100% 100%,
                100% 100%,
                100% 100%;
            background-position: 
                center center, /* ãƒ­ã‚´ã‚’ä¸­å¤®ã«é…ç½® */
                center center,
                center center,
                center center;
            background-repeat: no-repeat;
            opacity: 0.15; /* ãƒ­ã‚´ã‚’é€éã—ã¦è–„ãè¡¨ç¤º */
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–ã—ã¦ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã« */
            z-index: -1; /* æœ€èƒŒæ™¯ã¨ã—ã¦è¡¨ç¤ºï¼ˆä»–ã®è¦ç´ ã®å¾Œã‚ã«é…ç½®ï¼‰ */
        }
        #quiz-overlay.show {
            opacity: 1;
        }
        
        @keyframes pulseGlow {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.4; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.6; }
        }
        
        /* å•é¡Œæ–‡ã®å‰å£ä¸Šã¨å®Ÿéš›ã®å•é¡Œã®é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’é…ç½® */
        #quiz-question-wrapper {
            position: relative;
            width: 100%;
        }
        
        #quiz-question-intro {
            font-size: clamp(1.2em, 2.5vw, 1.8em); /* 16:9ç”»é¢ã«å¿œã˜ã¦èª¿æ•´ */
            text-align: center;
            margin-bottom: 0;
            color: rgba(255, 255, 255, 0.9);
            min-height: 3vh;
            padding-bottom: 0; /* ç©ºç™½ã‚’å‰Šé™¤ */
        }
        
        /* ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºï¼ˆå•é¡Œãƒ‘ãƒãƒ«ã®ä¸­å¤®ä¸Šã«é…ç½®ã€16:9æœ€é©åŒ–ï¼‰ */
        #quiz-timer {
            position: absolute;
            top: -7vh;
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(2em, 4vw, 3em); /* 16:9ç”»é¢ã«å¿œã˜ã¦èª¿æ•´ */
            font-weight: bold;
            color: #ffeb3b;
            text-shadow: 0 0 20px rgba(255, 235, 59, 0.8);
            z-index: 1002;
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.6);
            padding: 1vh 2vw;
            border-radius: 8px;
            border: 2px solid #ffeb3b;
            box-shadow: 0 0 15px rgba(255, 235, 59, 0.5);
            text-align: center; /* æ•°å€¤ã‚’ä¸­å¤®æƒãˆ */
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px; /* ä¸­å¤®æƒãˆã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®æœ€å°å¹… */
        }
        
        #quiz-question-main {
            font-size: clamp(1.8em, 4vw, 2.8em); /* 16:9ç”»é¢ã«å¿œã˜ã¦èª¿æ•´ */
            font-weight: bold;
            text-align: center;
            line-height: 1.4;
            margin-top: 0; /* ãƒªãƒ¼ãƒ‰æ–‡ã¨ã®é–“ã®ç©ºç™½ã‚’å‰Šé™¤ */
            clear: both;
            color: white; /* å•é¡Œæ–‡ã®è‰²ã‚’ç™½è‰²ã«çµ±ä¸€ */
        }
        
        /* é¸æŠè‚¢Dã‹ã‚‰æŠ½å‡ºã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’å•é¡Œæ–‡ã«è¡¨ç¤ºï¼ˆãƒªãƒ¼ãƒ‰æ–‡ã‚ˆã‚Šã•ã‚‰ã«å°ã•ã„æ–‡å­—ã‚µã‚¤ã‚ºï¼‰ */
        #quiz-question-comment {
            font-size: clamp(1em, 2vw, 1.5em); /* 16:9ç”»é¢ã«å¿œã˜ã¦èª¿æ•´ */
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            margin-top: 1.5vh;
            line-height: 1.5;
            font-weight: normal;
        }
        #quiz-timer.warning {
            color: #ff5252;
            text-shadow: 0 0 20px rgba(255, 82, 82, 0.8);
            border-color: #ff5252;
            box-shadow: 0 0 15px rgba(255, 82, 82, 0.5);
            animation: timerPulse 1s ease-in-out infinite;
        }
        @keyframes timerPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.1); }
        }
        
        /* å•é¡Œç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆ16:9æœ€é©åŒ–ï¼‰ */
        #quiz-image-container {
            width: 100%;
            max-width: 50vw; /* 16:9ç”»é¢ã§ã¯æ¨ªæ–¹å‘ã®50% */
            height: 25vh; /* ç¸¦æ–¹å‘ã®25% */
            margin-bottom: 2vh;
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid #b4143c;
            box-shadow: 0 0 30px rgba(180, 20, 60, 0.6), 0 0 60px rgba(111, 1, 37, 0.4);
            position: relative;
            z-index: 1;
        }
        #quiz-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: linear-gradient(135deg, #460117 0%, #6f0125 100%);
        }

        #quiz-question { 
            margin-bottom: 2vh; 
            margin-top: 8vh; /* ã‚¿ã‚¤ãƒãƒ¼ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
            animation: fadeInUp 0.5s ease-out;
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #b4143c;
            border-radius: 12px;
            padding: 1.5vh 3vw; /* ç¸¦ã®paddingã‚’ç¸®å°ï¼ˆ2vh â†’ 1.5vhï¼‰ */
            box-shadow: 0 0 30px rgba(180, 20, 60, 0.6), 0 0 60px rgba(111, 1, 37, 0.4);
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 85vw; /* 16:9ç”»é¢ã§ã¯æ¨ªæ–¹å‘ã®85% */
            visibility: visible;
            opacity: 1;
        }
        
        /* quiz-questionãŒéè¡¨ç¤ºçŠ¶æ…‹ã®ã‚¯ãƒ©ã‚¹ï¼ˆç”»é¢å¤–ã«ç§»å‹•ï¼‰ */
        #quiz-question.hidden {
            position: absolute;
            left: -9999px;
            top: -9999px;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
        }
        
        #quiz-question-number {
            text-align: center;
            font-size: clamp(1.2rem, 2vw, 1.8rem);
            font-weight: 700;
            color: #b4143c;
            margin-bottom: 1.5vh;
            text-shadow: 0 0 10px rgba(180, 20, 60, 0.9), 0 0 20px rgba(111, 1, 37, 0.6);
        }
        
        #quiz-options { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 2vw; 
            width: 100%;
            max-width: 85vw; /* 16:9ç”»é¢ã§ã¯æ¨ªæ–¹å‘ã®85% */
        }
        .option-btn {
            background: rgba(0, 0, 0, 0.8); 
            color: white; 
            border: 3px solid #b4143c;
            padding: 2vh 2vw; 
            font-size: clamp(1.2em, 2.5vw, 1.8em); /* 16:9ç”»é¢ã«å¿œã˜ã¦èª¿æ•´ */
            font-weight: bold; 
            border-radius: 12px;
            cursor: pointer; 
            transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s, border-width 0.3s, background 0.3s; 
            box-shadow: 0 0 20px rgba(180, 20, 60, 0.4), 0 0 40px rgba(111, 1, 37, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-align: left;
            min-height: 12vh; /* 16:9ç”»é¢ã§ã¯ç¸¦æ–¹å‘ã®12% */
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.5s ease-out;
            animation-fill-mode: forwards;
        }
        
        .option-btn-content {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .option-vote-percentage {
            font-size: clamp(1.5em, 3vw, 2.5em);
            font-weight: 700;
            color: var(--sophia-claret-light);
            text-shadow: 0 0 10px rgba(180, 20, 60, 0.8);
            margin-left: 1vw;
            min-width: 60px;
            text-align: right;
        }
        .option-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 5px;
            height: 100%;
            background: #b4143c;
            transition: width 0.3s;
        }
        .option-btn:nth-child(1) { animation-delay: 0.1s; }
        .option-btn:nth-child(2) { animation-delay: 0.2s; }
        .option-btn:nth-child(3) { animation-delay: 0.3s; }
        .option-btn:nth-child(4) { animation-delay: 0.4s; }
        .option-btn:hover:not(.disabled) { 
            transform: translateY(-5px) scale(1.02) !important; 
            box-shadow: 
                0 0 20px rgba(255, 0, 0, 0.8),
                0 0 40px rgba(255, 0, 0, 0.6),
                0 0 60px rgba(255, 0, 0, 0.4),
                0 0 80px rgba(180, 20, 60, 0.3),
                inset 0 0 30px rgba(255, 0, 0, 0.2);
            border-color: #ff0000;
            border-width: 4px;
            background: rgba(255, 0, 0, 0.1);
            animation: neonPulse 1.5s ease-in-out infinite;
            animation-fill-mode: forwards;
        }
        .option-btn:hover:not(.disabled)::before {
            width: 100%;
            opacity: 0.3;
            background: #ff0000;
        }

        @keyframes neonPulse {
            0%, 100% {
                box-shadow: 
                    0 0 20px rgba(255, 0, 0, 0.8),
                    0 0 40px rgba(255, 0, 0, 0.6),
                    0 0 60px rgba(255, 0, 0, 0.4),
                    0 0 80px rgba(180, 20, 60, 0.3),
                    inset 0 0 30px rgba(255, 0, 0, 0.2);
            }
            50% {
                box-shadow: 
                    0 0 30px rgba(255, 0, 0, 1),
                    0 0 60px rgba(255, 0, 0, 0.8),
                    0 0 90px rgba(255, 0, 0, 0.6),
                    0 0 120px rgba(180, 20, 60, 0.5),
                    inset 0 0 40px rgba(255, 0, 0, 0.3);
            }
        }
        .option-btn:active:not(.disabled) { 
            transform: translateY(2px) scale(0.98); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .option-btn.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .option-btn.correct {
            background: #4CAF50;
            color: white;
            animation: correctPulse 0.6s ease-out;
        }
        .option-btn.incorrect {
            background: #f44336;
            color: white;
            animation: shake 0.5s ease-out;
        }
        .option-btn.show-correct {
            background: #4CAF50;
            color: white;
            border: 3px solid #fff;
        }

        #quiz-feedback {
            margin-top: 3vh;
            font-size: clamp(1.8em, 4vw, 2.8em); /* 16:9ç”»é¢ã«å¿œã˜ã¦èª¿æ•´ã€å•é¡Œæ–‡ã¨åŒã˜ã‚µã‚¤ã‚º */
            font-weight: bold;
            text-align: center;
            min-height: 5vh;
            animation: fadeInUp 0.5s ease-out;
            max-width: 85vw; /* 16:9ç”»é¢ã§ã¯æ¨ªæ–¹å‘ã®85% */
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼ˆå•é¡Œç”»é¢ã§ã¯ä¸è¦ï¼‰ */
        }

        /* æ­£è§£/ä¸æ­£è§£ç”»åƒ */
        .quiz-result-image {
            display: block;
            margin: 0;
            width: clamp(120px, 16vw, 240px); /* 20%ç¸®å°ï¼ˆå…ƒã®80%ï¼‰ */
            height: auto;
            animation: fadeInScale 0.6s ease-out;
            flex-shrink: 0; /* ç¸®å°ã‚’é˜²ã */
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        #quiz-feedback.correct {
            color: #4CAF50;
        }
        #quiz-feedback.incorrect {
            color: #ffeb3b;
        }

        #quiz-explanation {
            margin-top: 2vh;
            font-size: clamp(1.8em, 4vw, 2.8em); /* 16:9ç”»é¢ã«å¿œã˜ã¦èª¿æ•´ã€å•é¡Œæ–‡ã¨åŒã˜ã‚µã‚¤ã‚º */
            text-align: center;
            max-width: 85vw; /* 16:9ç”»é¢ã§ã¯æ¨ªæ–¹å‘ã®85% */
            line-height: 1.6;
            padding: 2vh 3vw;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            animation: fadeInUp 0.5s ease-out;
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼ˆå•é¡Œç”»é¢ã§ã¯ä¸è¦ï¼‰ */
        }
        
        /* è§£èª¬å†…ã®ç”»åƒã‚¹ã‚¿ã‚¤ãƒ« */
        #quiz-explanation img {
            max-width: 100%;
            height: auto;
            margin: 2vh auto;
            border-radius: 8px;
            display: block;
        }

        #quiz-actions {
            margin-top: 3vh;
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼ˆå•é¡Œç”»é¢ã§ã¯ä¸è¦ï¼‰ */
            gap: 1.5vw;
            animation: fadeInUp 0.5s ease-out;
            justify-content: center;
            position: relative;
            z-index: 10; /* ãƒœã‚¿ãƒ³ãŒä»–ã®è¦ç´ ã®ä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã« */
        }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ãŒå¿…è¦ãªæ™‚ã¯è¡¨ç¤º */
        #quiz-actions:not(:empty) {
            display: flex;
        }
        .quiz-action-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            font-size: clamp(1em, 2vw, 1.5em); /* 16:9ç”»é¢ã«å¿œã˜ã¦èª¿æ•´ */
            padding: 1.5vh 3vw;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            position: relative;
            z-index: 11; /* ãƒœã‚¿ãƒ³ãŒç¢ºå®Ÿã«ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã« */
            pointer-events: auto; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ– */
        }
        .quiz-action-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        #close-overlay { 
            position: absolute; 
            top: 30px; 
            right: 30px; 
            background: rgba(255,255,255,0.2); 
            border: 1px solid white; 
            color: white; 
            font-size: 1rem; 
            padding: 10px 20px; 
            border-radius: 30px; 
            cursor: pointer; 
            transition: background 0.2s;
            z-index: 1002; /* QRã‚³ãƒ¼ãƒ‰ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
        }
        #close-overlay:hover {
            background: rgba(255,255,255,0.4);
        }
        
        /* QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        #quiz-qr-code {
            position: absolute;
            top: 80px; /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ä¸‹ã«é…ç½®ï¼ˆ30px + ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° + ãƒãƒ¼ã‚¸ãƒ³ï¼‰ */
            right: 2vw;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.95);
            padding: 1vh 1vw;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        #quiz-qr-code img {
            width: clamp(80px, 12vw, 150px);
            height: auto;
            display: block;
        }
        
        #quiz-qr-code div {
            text-align: center;
            margin-top: 0.5vh;
            font-size: clamp(0.7rem, 1.5vw, 1rem);
            color: #333;
        }
        
        #quiz-qr-code a {
            color: #b4143c;
            text-decoration: none;
            word-break: break-all;
        }
        
        #quiz-qr-code a:hover {
            text-decoration: underline;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* é¸æŠè‚¢ã®ãƒ©ãƒ™ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .option-btn {
            padding-left: 60px;
        }
        .option-label {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.8em;
            color: #b4143c;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(180, 20, 60, 0.9), 0 0 20px rgba(111, 1, 37, 0.6);
        }
        
        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 600px) {
            #quiz-question { 
                font-size: 1.5em; 
                margin-bottom: 2vh; 
                padding: 2vh 3vw; 
                max-width: 95vw;
            }
            #quiz-options { 
                grid-template-columns: 1fr; 
                gap: 2vh; 
                max-width: 95vw;
            }
            .option-btn { 
                font-size: 1.2em; 
                padding: 2vh 2vw 2vh 50px; 
                min-height: 10vh; 
            }
            .option-label { font-size: 1.5em; left: 10px; }
            #quiz-feedback { font-size: 1.8em; max-width: 95vw; }
            #quiz-explanation { font-size: 1.8em; padding: 2vh 3vw; max-width: 95vw; }
            #quiz-timer { 
                font-size: 2em; 
                top: -6vh; 
                left: 50%;
                transform: translateX(-50%);
                padding: 1vh 2vw;
            }
            #quiz-image-container { 
                height: 20vh; 
                margin-bottom: 2vh; 
                max-width: 95vw;
            }
        }
        
        /* 16:9ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã®æœ€é©åŒ–ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ç”¨ï¼‰ */
        @media (min-aspect-ratio: 16/9) {
            #quiz-overlay {
                padding: 1vh 5vw;
            }
            #quiz-question {
                max-width: 80vw;
                padding: 2.5vh 4vw;
            }
            #quiz-options {
                max-width: 80vw;
                gap: 2.5vw;
            }
            #quiz-image-container {
                max-width: 45vw;
                height: 28vh;
            }
            #quiz-feedback,
            #quiz-explanation {
                max-width: 80vw;
            }
        }

    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>

    <!-- éŸ³æ¥½ãƒœã‚¿ãƒ³ -->
    <div id="music-toggle" class="muted" onclick="toggleMusic()">ğŸ”Š</div>

    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="character-container">
        <img src="assets/åœ§ç¸®ç‰ˆ_sophiankun.gif" alt="ã‚½ãƒ•ã‚£ã‚¢ãã‚“">
    </div>

    <div id="chat-container">
        <div class="message bot">
            <div class="message-text">ã“ã‚“ã«ã¡ã¯ï¼ã‚½ãƒ•ã‚£ã‚¢ãã‚“ã§ã™ï¼åšå ±å ‚ã®çš†ã•ã‚“æ°—è»½ã«è³ªå•ã—ã¦ã­ï¼</div>
        </div>
    </div>

    <div id="input-area">
        <input type="text" id="user-input" placeholder="è³ªå•ã‚’å…¥åŠ›" onkeypress="if(event.key==='Enter') sendMessage()">
        <button id="send-btn" onclick="sendMessage()">é€ä¿¡</button>
    </div>

    <div id="quiz-overlay">
        <button id="close-overlay" onclick="closeQuiz()">Ã— é–‰ã˜ã‚‹</button>
        <div id="quiz-qr-code" style="position: absolute; top: 80px; right: 2vw; z-index: 1001; background: rgba(255, 255, 255, 0.95); padding: 1vh 1vw; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
            <img src="QR.png" alt="QR Code" style="width: clamp(80px, 12vw, 150px); height: auto; display: block;">
            <div style="text-align: center; margin-top: 0.5vh; font-size: clamp(0.7rem, 1.5vw, 1rem); color: #333;">
                <a href="https://nikaishimpei.github.io/sph/quiz-form/quiz-form.html" target="_blank" style="color: #b4143c; text-decoration: none; word-break: break-all;">
                    å‚åŠ ç™»éŒ²
                </a>
            </div>
        </div>
        <div id="quiz-image-container" style="display: none;">
            <img id="quiz-image" src="" alt="å•é¡Œã«é–¢é€£ã™ã‚‹ç”»åƒ">
        </div>
        <div id="quiz-question">
            <div id="quiz-timer">60</div>
            <div id="quiz-question-number" style="display: none;"></div>
            <div id="quiz-question-wrapper">
                <div id="quiz-question-intro"></div>
                <div id="quiz-question-main">ã“ã“ã«å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                <div id="quiz-question-comment"></div>
            </div>
        </div>
        <div id="quiz-options"></div>
        <div id="quiz-feedback"></div>
        <div id="quiz-explanation"></div>
        <div id="quiz-actions"></div>
    </div>

    <script>
        // ===== FirebaseåˆæœŸåŒ– =====
        const firebaseConfig = {
            apiKey: "AIzaSyDFQCgaQo_q3sqx7SfypA8CjOAiH5tOKII",
            authDomain: "sophia-quiz-2025.firebaseapp.com",
            databaseURL: "https://sophia-quiz-2025-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sophia-quiz-2025",
            storageBucket: "sophia-quiz-2025.firebasestorage.app",
            messagingSenderId: "131577494118",
            appId: "1:131577494118:web:3ad280a0b7bd9a28e50ba7"
        };
        
        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ===== Dify APIè¨­å®š =====
        // API_KEYã¨BASE_URLã¯config.jsã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã¾ã™

        // â˜…ä¼šè©±IDã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°ï¼ˆæœ€åˆã¯ç©ºï¼‰
        // ã“ã‚ŒãŒã‚ã‚‹ãŠã‹ã’ã§ã€2å›ç›®ä»¥é™ã‚‚ã€Œã•ã£ãã®ç¶šãã€ã ã¨èªè­˜ã•ã‚Œã¾ã™
        let currentConversationId = "";
        
        // ã‚¯ã‚¤ã‚ºé–¢é€£ã®çŠ¶æ…‹ç®¡ç†
        let currentQuizData = null;
        let quizAnswered = false;
        let quizTimer = null;
        let timeRemaining = 60;
        
        // å›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ç®¡ç†
        let isFixedQuizMode = false;
        let currentQuestionNumber = 0;
        let isWaitingForQRConfirmation = false; // QRã‚³ãƒ¼ãƒ‰ç¢ºèªå¾…ã¡ãƒ•ãƒ©ã‚°
        
        // Firebaseé–¢é€£ã®çŠ¶æ…‹ç®¡ç†
        let voteListener = null; // æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒŠãƒ¼
        let currentQuizSessionId = null; // ç¾åœ¨ã®ã‚¯ã‚¤ã‚ºã‚»ãƒƒã‚·ãƒ§ãƒ³ID
        let currentVoteListener = null; // ç¾åœ¨ã®å•é¡Œã®æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒŠãƒ¼
        
        // 12å•ã®å›ºå®šã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿
        const fixedQuizQuestions = [
            {
                question: "æ—¥çµŒæ–°èãŒ25å¹´ã«è¡Œã£ãŸèª¿æŸ»<br>ã€Œäººäº‹ãŒè¦‹ã‚‹ å’æ¥­ç”Ÿæ´»èºã®å¤§å­¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€ã€‚<br>1ä½ã¯ä¸€æ©‹å¤§å­¦ã€‚ã§ã¯ã€ ä¸Šæ™ºã¯ä½•ä½?",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "   2ä½",
                    "   5ä½",
                    "   8ä½",
                    "  14ä½"
                ],
                correctAnswer: 0, // A
                explanation: "è¡Œå‹•åŠ›ã€ã‚³ãƒŸãƒ¥åŠ›ã€æ€è€ƒåŠ›ã€æˆé•·åŠ›ãŒé«˜æ°´æº–ã ã£ãŸã®ã«åŠ ãˆã€ç‰¹ã«èªå­¦åŠ›ã«é•·ã‘ã¦ã„ã‚‹ãªã©ã‚°ãƒ­ãƒ¼ãƒãƒ«äººæè¼©å‡ºã¸ã®è©•ä¾¡ãŒé«˜ã‹ã£ãŸã€‚\nãªãŠã€äº¬å¤§ã¯4ä½ã€æ…¶æ‡‰ã¯11ä½ã€æ—©ç¨²ç”°ã¯16ä½ã€æ±å¤§ã¯20ä½ã€‚",
                images: ["q1.png"]
            },
            {
                question: "ç¾åœ¨åšå ±å ‚ã®ç¤¾å“¡ã®ã†ã¡ã€ä¸Šæ™ºå‡ºèº«è€…ã¯140åã»ã©ã§ã™ãŒã€<br>ã©ã®å­¦éƒ¨å‡ºèº«ãŒå¤šã„ã§ã—ã‚‡ã†ã€‚ãƒˆãƒƒãƒ—ï¼“ã‚’ãŠé¸ã³ãã ã•ã„ã€‚",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "1ä½ å¤–å›½èªå­¦éƒ¨  2ä½ çµŒæ¸ˆå­¦éƒ¨ 3ä½ æ–‡å­¦éƒ¨",
                    "1ä½ ç†å·¥å­¦éƒ¨  2ä½ æ³•å­¦éƒ¨  3ä½ çµŒæ¸ˆå­¦éƒ¨",
                    "1ä½ æ–‡å­¦éƒ¨  2ä½ çµŒæ¸ˆå­¦éƒ¨ 3ä½ ç·åˆäººé–“ç§‘å­¦éƒ¨",
                    "1ä½ çµŒæ¸ˆå­¦éƒ¨  2ä½ æ–‡å­¦éƒ¨  ï¼“ä½ ç†å·¥å­¦éƒ¨"
                ],
                correctAnswer: 3, // D
                explanation: "",
                images: ["q2.png"],
                imageScale: 1.2
            },
            {
                question: "ä¸Šæ™ºå¤§å­¦ã®ç”·å¥³æ¯”ã¯24å¹´åº¦ã§ã¯å…¨ä½“ã ã¨ã€ç”·35:å¥³65ã§ã™ã€‚<br>ä¸€ç•ªå¥³æ€§æ¯”ç‡ãŒé«˜ã„å­¦ç§‘ã¯çœ‹è­·å­¦ç§‘ã§ã™ãŒã€2ä½ã¯ã©ã“ï¼Ÿ",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "å¿ƒç†å­¦ç§‘",
                    "ãƒ•ãƒ©ãƒ³ã‚¹æ–‡å­¦ç§‘",
                    "ç¤¾ä¼šç¦ç¥‰å­¦ç§‘",
                    "å›½æ–‡å­¦ç§‘"
                ],
                correctAnswer: 0, // A
                explanation: "å¿ƒç†å­¦ç§‘ 85%ã€ç¤¾ä¼šç¦ç¥‰å­¦ç§‘ 82%ã€ãƒ•ãƒ©ãƒ³ã‚¹æ–‡å­¦ç§‘ 80%ã€å›½æ–‡å­¦ç§‘ 79% ã§ã—ãŸã€‚"
            },
            {
                question: "25å¹´ å¥³æ€§åˆã®ç·ç†ã§ã‚ã‚‹é«˜å¸‚æ”¿æ¨©ãŒèª•ç”Ÿã—ã¾ã—ãŸãŒã€<br>ä¸Šæ™ºã‚‚25å¹´ã«å¥³æ€§åˆã®æ‰æ‘å­¦é•·ãŒèª•ç”Ÿã—ã¾ã—ãŸã€‚<br>å½¼å¥³ãŒè‡ªèº«ã®å½¹å‰²ã¨ã—ã¦å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã¯ä½•ï¼Ÿ",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã‚·ãƒƒãƒ—",
                    "ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªã‚¨ã‚¤ã‚·ãƒ§ãƒ³",
                    "ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ã‚·ãƒ§ãƒ³",
                    "ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³"
                ],
                correctAnswer: 2, // C
                explanation: "è‡ªã‚‰ã‚’ã€Œèª¿æ•´å½¹ï¼ˆã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã€ã¨è¡¨ç¾ã—ã€å­¦éƒ¨ã‚„å¤§å­¦ã€å›½å¢ƒã‚’è¶Šãˆã¦æ§˜ã€…ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«äººã‚’å·»ãè¾¼ã‚“ã§ã„ãå§¿å‹¢ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã€Œã¿ã‚“ãªã«å¯„ã‚Šæ·»ã£ã¦ã€ã¿ã‚“ãªãŒç¹‹ãŒã‚‹ã‚ˆã†ãªå ´ã‚’ä½œã‚‹ã“ã¨ãŒã€å­¦é•·ã¨ã—ã¦ã®ç§ã®ä½¿å‘½ã€ã¨èªã£ã¦ãŠã‚Šã€ç²’é•ã„ã‚’é‡è¦–ã™ã‚‹åšå ±å ‚ã¨å…±é€šç‚¹ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
                images: ["q4.png"]
            },
            {
                question: "ä¸Šæ™ºå‡ºèº«ã®æœ‰åYoutuberã¯èª°ã§ã—ã‚‡ã†ï¼Ÿ",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "ãƒ˜ãƒ©ãƒ˜ãƒ©ä¸‰éŠƒå£«",
                    "å¹³æˆãƒ•ãƒ©ãƒŸãƒ³ã‚´",
                    "ãƒ•ã‚£ãƒƒã‚·ãƒ£ãƒ¼ã‚º",
                    "ã‚³ãƒ ãƒ‰ãƒƒãƒˆ"
                ],
                correctAnswer: 3, // D
                explanation: "ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²è€…æ•°400ä¸‡äººä»¥ä¸Šã®5äººçµ„ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚³ãƒ ãƒ‰ãƒƒãƒˆã®ãƒªãƒ¼ãƒ€ãƒ¼ãƒ»ãƒ¤ãƒãƒˆã•ã‚“ã¯ã€ä¸Šæ™ºã®ç·åˆã‚°ãƒ­ãƒ¼ãƒãƒ«å­¦éƒ¨ã§ã—ãŸãŒã€2023å¹´4æœˆã«Youtubeæ´»å‹•ã«å°‚å¿µã™ã‚‹ãŸã‚é€€å­¦ã—ã¾ã—ãŸã€‚æ ªå¼ä¼šç¤¾BRDOCKã¨ã„ã†ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã®ç¤¾é•·ã‚‚å‹™ã‚ã¦ã„ã¾ã™ã€‚",
                images: ["q5.png"]
            },
            {
                question: "25å¹´ ä¸Šæ™ºå¤§å­¦ã‹ã‚‰åˆã®ãƒ—ãƒ­é‡çƒãƒ‰ãƒ©ãƒ•ãƒˆæŒ‡åãŒèª•ç”Ÿã€‚<br>ãƒ©ã‚¤ã‚ªãƒ³ã‚ºè‚²æˆæ 6ä½ã§æŒ‡åã‚’å—ã‘ãŸæ­£æœ¨æ‚ é¦¬é¸æ‰‹ã€‚<br>ä¸Šæ™ºã®ãŠç¥ã„ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã«ã©ã®ã‚ˆã†ã«å›ç­”ã—ãŸï¼Ÿ",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "ä¸Šæ™ºå¤§å­¦åˆã®ãƒ—ãƒ­é‡çƒé¸æ‰‹ã§èº«ãŒå¼•ãç· ã¾ã‚‹æ€ã„ã ã€‚",
                    "å¤§å­¦ã§ã¯ã‚¹ãƒšã‚¤ãƒ³èªã‚‚å­¦ã‚“ã ã€ã„ãšã‚Œæµ·å¤–ã«ã‚‚æŒ‘æˆ¦ã—ãŸã„ã€‚",
                    "å…¥å­¦æ™‚ã‚¢ãƒ¡ãƒ•ãƒˆéƒ¨ã«å…¥ã‚ã†ã¨æ€ã£ã¦ã„ãŸãŒã€é‡çƒéƒ¨ã«ã—ã¦è‰¯ã‹ã£ãŸã€‚",
                    "ä¸Šæ™ºå¤§å­¦ã®ç·´ç¿’ç’°å¢ƒã¯ã‹ãªã‚Šæ‚ªã‹ã£ãŸã€‚"
                ],
                correctAnswer: 3, // D
                explanation: "æ­£æœ¨æ‚ é¦¬é¸æ‰‹ï¼ˆçµŒå–¶å­¦ç§‘ï¼‰ã¯ã€å°‚é–€ã®ã‚³ãƒ¼ãƒã‚„ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ãŒã„ãªã„ç’°å¢ƒã®ä¸­ã§ã‚‚ç‹¬å­¦ã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚„ãƒ•ã‚©ãƒ¼ãƒ ç ”ç©¶ã‚’è¡Œã„ã€å…¥å­¦å½“åˆã¯140kmã ã£ãŸçƒé€Ÿã‚’153kmã¾ã§ä¼¸ã°ã—ã¾ã—ãŸã€‚",
                images: ["q6.png", "q6_2.png"]
            },
            {
                question: "2023å¹´~25å¹´ã«ã‹ã‘ã¦ã®å’æ¥­ç”Ÿã®å°±è·å…ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®<br>ç´¯è¨ˆtop3ã®ã†ã¡æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œï¼Ÿ",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "1ä½ æ¥½å¤©  2ä½ ã‚¢ã‚¯ã‚»ãƒ³ãƒãƒ¥ã‚¢ 3ä½ NTTãƒ‡ãƒ¼ã‚¿",
                    "1ä½ ã‚¢ã‚¯ã‚»ãƒ³ãƒãƒ¥ã‚¢  2ä½ æ—¥ç«‹è£½ä½œæ‰€  3ä½ ãƒ‰ã‚³ãƒ¢",
                    "1ä½ ã¿ãšã»  2ä½ æ¥½å¤©  3ä½ NTTãƒ‡ãƒ¼ã‚¿",
                    "1ä½ NTTãƒ‡ãƒ¼ã‚¿  2ä½ LVMH 3ä½ ANA"
                ],
                correctAnswer: 0, // A
                explanation: "",
                images: ["q7.png"],
                imageScale: 1.5
            },
            {
                question: "ä¸Šæ™ºå¤§å­¦ã®å¹´é–“ã®åºƒå‘Šãƒ»åºƒå ±äºˆç®—ã¯ã©ã‚Œãã‚‰ã„ã§ã—ã‚‡ã†ï¼Ÿ",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "1å„„å††æœªæº€",
                    "1å„„~3å„„æœªæº€",
                    "3å„„~5å„„æœªæº€",
                    "5å„„~7å„„æœªæº€"
                ],
                correctAnswer: 2, // C
                explanation: "äº‹æ¥­å ±å‘Šæ›¸ã«ã‚ˆã‚‹ã¨3.1å„„å††ã§ã™ã€‚Hã‚°ãƒ«ãƒ¼ãƒ—ãŒAEã«ãªã‚Œã°ã‚®ãƒªã‚®ãƒªã„ã‘ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚"
            },
            {
                question: "ä¸Šæ™ºå¤§å­¦ã®å¯„ä»˜é‡‘ã¯å¹´é–“ã§ã„ãã‚‰ãã‚‰ã„ï¼Ÿ",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "ç´„5å„„å††",
                    "ç´„7å„„å††",
                    "ç´„9å„„å††",
                    "ç´„11å„„å††"
                ],
                correctAnswer: 0, // A
                explanation: "ã¡ãªã¿ã«æ…¶æ‡‰ã¯ç´„53å„„å††ã€æ—©ç¨²ç”°ã¯33å„„ã§ã™ã€‚å’æ¥­ç”Ÿã®äººæ•°ä»¥ä¸Šã®åŸå› ãŒã‚ã‚Šãã†ã§ã™ã€‚",
                images: ["q9.png"]
            },
            {
                question: "åšå ±å ‚ã¯ä¸Šæ™ºã«å¯„ä»˜ã‚’ã—ã¦ã„ã¾ã›ã‚“ãŒã€<br>ä»¥ä¸‹ã®ã†ã¡ã€å¯„ä»˜ã‚’ã—ã¦ã„ãªã„ä¼æ¥­/å›£ä½“ã¯ã©ã‚Œï¼Ÿ",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "NTTãƒ‡ãƒ¼ã‚¿",
                    "ã‚¤ã‚ªãƒ³1%ã‚¯ãƒ©ãƒ–",
                    "ã‚¢ã‚µãƒ’ã‚°ãƒ«ãƒ¼ãƒ—",
                    "ã‚ã„ãŠã„ãƒ‹ãƒƒã‚»ã‚¤æä¿"
                ],
                correctAnswer: 0, // A
                explanation: "ã‚¤ã‚ªãƒ³ï¼‘%ã‚¯ãƒ©ãƒ–ã¯25å¹´ã«1000ä¸‡å††ã€ã“ã‚Œã¾ã§ã®ç´¯è¨ˆã§1å„„å††ä»¥ä¸Šã®å¯„ä»˜ã‚’ã—ã¦ãŠã‚Šã€ä¼æ¥­ã®ä¸­ã§ã¯ã»ã¼ãƒˆãƒƒãƒ—ã§ã™ã€‚æ‹…å½“ã•ã‚Œã¦ã„ã‚‹å¼•ç”°ã•ã‚“ã¯ã„ãã‚‰å¯„ä»˜ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ"
            },
            {
                question: "ä¸Šæ™ºå’ã®åšå ±å ‚ç¤¾å“¡ã®ã†ã¡ã€<br>ä¸Šæ™ºã«å¯„ä»˜ã‚’ã—ã¦ã„ã‚‹äººãŸã¡ã®å¯„ä»˜é‡‘ã®åˆè¨ˆé¡ã¯<br>2025å¹´ã¯åˆè¨ˆã„ãã‚‰ã ã£ãŸã§ã—ã‚‡ã†ã€‚",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "0~1ä¸‡å††æœªæº€",
                    "1ä¸‡~10ä¸‡å††æœªæº€",
                    "10ä¸‡~20ä¸‡å††æœªæº€",
                    "20ä¸‡ã€œ30ä¸‡æœªæº€"
                ],
                correctAnswer: 0, // A
                explanation: "25å¹´ã€ä¸Šæ™ºã«å¯„ä»˜ã‚’ã—ã¦ã„ã‚‹äººã¯åšå ±å ‚ç¤¾å“¡ã§ã¯ãŸã£ãŸã®1äººã€‚<br>25å¹´å…¥ç¤¾ã§BD3å±€ã®å¤§å´ è‰å­ã•ã‚“(æ–°èå­¦ç§‘å’)ã§ã™ï¼<br><span style=\"font-size: clamp(1.5rem, 3.5vw, 2.5rem); font-weight: bold; color: #f44336;\">ä¸Šæ™ºå’ã®è«¸å…ˆè¼©æ–¹ã«ãŠã‹ã‚Œã¾ã—ã¦ã¯æ¥ã‚’çŸ¥ã£ã¦ãã ã•ã„ã€‚</span>",
                images: ["q11.png"]
            },
            {
                question: "ç¾åœ¨ã®ä¸Šæ™ºå¤§å­¦ã®çµŒå–¶èª²é¡Œã¯ï¼Ÿ",
                comment: "å¥½ããªé¸æŠè‚¢ (A~D)ã‚’ç­”ãˆã¦ã­!",
                options: [
                    "æŠ•è³‡é‹ç”¨ã«ã‚ˆã‚‹é‹ç”¨ç›Šã«ã‚ˆã‚Šé»’å­—ã ãŒã€å¸‚å ´ãƒªã‚¹ã‚¯ç®¡ç†ã¨æ”»ã‚ã®æŠ•è³‡ç¶™ç¶šãŒèª²é¡Œã€‚",
                    "è¨­å‚™æŠ•è³‡ã‚„è£œåŠ©é‡‘æ¸›ã§å¤§å¹…ãªèµ¤å­—ã€è²¡æ”¿ãƒ»ç®¡ç†ä½“åˆ¶ã®ç«‹ã¦ç›´ã—ãŒæœ€å„ªå…ˆã€‚",
                    "å¤§å¹…ãªçµŒè²»å‰Šæ¸›ã§é»’å­—ã‚’é”æˆã—ã¦ã„ã‚‹ãŒã€å­¦è²»ä¾å­˜ç‡ãŒé«˜ãã€å°†æ¥ã®æŠ•è³‡ä½™åŠ›ç¢ºä¿ãŒèª²é¡Œã€‚",
                    "èµ¤å­—ã‹ã‚‰ã®è„±å´ã¸å‘ã‘ã€ä¸æ¡ç®—éƒ¨é–€æ•´ç†ã‚„å­¦è²»ä¾å­˜ç‡ã‹ã‚‰ã®è„±å´ãªã©æ§‹é€ æ”¹é©ãŒæ€¥å‹™ã€‚"
                ],
                correctAnswer: 3, // D
                explanation: "é¸æŠè‚¢aã¯æ…¶æ‡‰ã€bã¯æ—¥æœ¬å¤§å­¦ã€cã¯ç«‹æ•™ã®èª²é¡Œã§ã™ã€‚\nä¸Šæ™ºã¯24å¹´åº¦ã¯10å„„å††ã®èµ¤å­—ã§ã‚ã‚Šã€æ§‹é€ æ”¹é©ãŒå¿…è¦ã¨ãªã£ã¦ã„ã¾ã™ã€‚ãªã®ã§çš†ã•ã‚“ã®å¯„ä»˜é‡‘ãŒå¿…è¦ã§ã™ã€‚"
            }
        ];
        
        // Unsplash APIï¼ˆç„¡æ–™ã§ä½¿ç”¨å¯èƒ½ã€APIã‚­ãƒ¼ä¸è¦ã®æ–¹æ³•ã‚’ä½¿ç”¨ï¼‰
        // æ³¨æ„: æœ¬ç•ªç’°å¢ƒã§ã¯APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨
        const UNSPLASH_ACCESS_KEY = ''; // å¿…è¦ã«å¿œã˜ã¦APIã‚­ãƒ¼ã‚’è¨­å®šï¼ˆç„¡æ–™ã§å–å¾—å¯èƒ½ï¼‰
        
        // ç”»åƒæ¤œç´¢é–¢æ•°ï¼ˆUnsplash APIã‚’ä½¿ç”¨ã€APIã‚­ãƒ¼ãªã—ã§ã‚‚å‹•ä½œã™ã‚‹æ–¹æ³•ï¼‰
        async function searchQuizImage(question) {
            try {
                // å•é¡Œæ–‡ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
                const keywords = extractKeywords(question);
                if (!keywords || keywords.length === 0) {
                    return null;
                }
                
                // Unsplash Source APIï¼ˆAPIã‚­ãƒ¼ä¸è¦ï¼‰ã‚’ä½¿ç”¨
                // ã¾ãŸã¯ã€Unsplash APIã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
                const searchQuery = encodeURIComponent(keywords.join(' '));
                
                // æ–¹æ³•1: Unsplash Source APIï¼ˆAPIã‚­ãƒ¼ä¸è¦ã€åˆ¶é™ã‚ã‚Šï¼‰
                const imageUrl = `https://source.unsplash.com/600x300/?${searchQuery}`;
                
                // æ–¹æ³•2: Unsplash APIã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼ˆAPIã‚­ãƒ¼ãŒå¿…è¦ï¼‰
                // if (UNSPLASH_ACCESS_KEY) {
                //     const response = await fetch(`https://api.unsplash.com/search/photos?query=${searchQuery}&per_page=1&client_id=${UNSPLASH_ACCESS_KEY}`);
                //     const data = await response.json();
                //     if (data.results && data.results.length > 0) {
                //         return data.results[0].urls.regular;
                //     }
                // }
                
                return imageUrl;
            } catch (error) {
                console.error('ç”»åƒæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }
        
        // å•é¡Œæ–‡ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
        function extractKeywords(question) {
            // æ—¥æœ¬èªã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
            const keywords = [];
            
            // ä¸Šæ™ºå¤§å­¦é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            if (question.includes('ä¸Šæ™º') || question.includes('ã‚½ãƒ•ã‚£ã‚¢')) {
                keywords.push('Sophia University');
            }
            if (question.includes('ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹')) {
                keywords.push('university campus');
            }
            if (question.includes('æ­´å²')) {
                keywords.push('history');
            }
            if (question.includes('å»ºç‰©') || question.includes('å»ºç¯‰')) {
                keywords.push('architecture');
            }
            if (question.includes('å­¦ç”Ÿ')) {
                keywords.push('students');
            }
            if (question.includes('å›³æ›¸é¤¨')) {
                keywords.push('library');
            }
            if (question.includes('å››ãƒ„è°·') || question.includes('Yotsuya')) {
                keywords.push('Yotsuya Tokyo');
            }
            
            // å¹´å·ã‚„æ•°å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
            const yearMatch = question.match(/\d{4}å¹´/);
            if (yearMatch) {
                keywords.push('university');
            }
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            if (keywords.length === 0) {
                keywords.push('university', 'education');
            }
            
            return keywords;
        }

        async function sendMessage() {
            const inputField = document.getElementById('user-input');
            if (!inputField) {
                console.error('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            const text = inputField.value;
            if (!text || !text.trim()) return;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessage(text, 'user');
            inputField.value = '';

            // Loadingè¡¨ç¤º
            const loadingId = addMessage('è€ƒãˆä¸­...', 'bot', true);

            try {
                // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
                const payload = {
                    inputs: {},
                    query: text,
                    response_mode: "blocking",
                    user: "guest-user",
                    files: []
                };

                // â˜…é‡è¦ï¼šã‚‚ã—ç¶šãã®ä¼šè©±ãªã‚‰ã€IDã‚’ã‚»ãƒƒãƒˆã—ã¦é€ä¿¡ã™ã‚‹
                if (currentConversationId) {
                    payload.conversation_id = currentConversationId;
                }

                // Dify APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch(`${BASE_URL}/chat-messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                
                // â˜…é‡è¦ï¼šAIã‹ã‚‰è¿”ã£ã¦ããŸã€Œä¼šè©±IDã€ã‚’ä¿å­˜ã—ã¦æ›´æ–°ã™ã‚‹
                if (data.conversation_id) {
                    currentConversationId = data.conversation_id;
                }
                
                // Loadingã‚’æ¶ˆã™
                const loadingMsg = document.getElementById(loadingId);
                if(loadingMsg) loadingMsg.remove();

                const aiResponse = data.answer;

                // quiz_startã¾ãŸã¯quiz_sophiaã‚’æ¤œå‡ºï¼ˆå›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼‰
                // å¤§æ–‡å­—å°æ–‡å­—ã‚’å•ã‚ãšã€ã‚¹ãƒšãƒ¼ã‚¹ã‚„ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®æœ‰ç„¡ã‚’å•ã‚ãšæ¤œå‡º
                const normalizedText = text.toLowerCase().trim().replace(/[_\s]+/g, ' ').replace(/\s+/g, ' ');
                const normalizedWithoutSpaces = normalizedText.replace(/\s/g, '');
                if (normalizedText === 'quiz start' || normalizedWithoutSpaces === 'quizstart' || 
                    normalizedText === 'quiz sophia' || normalizedWithoutSpaces === 'quizsophia') {
                    // QRã‚³ãƒ¼ãƒ‰ç¢ºèªå¾…ã¡ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
                    isWaitingForQRConfirmation = true;
                    
                    // QRã‚³ãƒ¼ãƒ‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    addMessage('OK, ã˜ã‚ƒã‚ã¾ãšã¯ã“ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ã€è‡ªåˆ†ã®åå‰ã‚’ç™»éŒ²ã—ã¦ã­ã€‚ç™»éŒ²ãŒçµ‚ã‚ã£ãŸã‚‰ã‚¯ã‚¤ã‚ºã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ã‚ˆ', 'bot');
                    
                    // QRã‚³ãƒ¼ãƒ‰ã‚’å¤§ããè¡¨ç¤º
                    const qrMessage = document.createElement('div');
                    qrMessage.className = 'message bot';
                    qrMessage.innerHTML = `
                        <div class="message-text">
                            <img src="QR.png" alt="QR Code" style="max-width: 60vw; height: auto; display: block; margin: 2vh auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                            <div style="text-align: center; margin-top: 1vh; font-size: clamp(1rem, 2.5vw, 1.3rem);">
                                <a href="https://nikaishimpei.github.io/sph/quiz-form/quiz-form.html" target="_blank" style="color: #ffeb3b; text-decoration: underline;">
                                    https://nikaishimpei.github.io/sph/quiz-form/quiz-form.html
                                </a>
                            </div>
                        </div>
                    `;
                    document.getElementById('chat-container').appendChild(qrMessage);
                    scrollToBottom();
                    
                    return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
                }
                
                // OKã¨å…¥åŠ›ã•ã‚ŒãŸå ´åˆã®å‡¦ç†ï¼ˆQRã‚³ãƒ¼ãƒ‰ç¢ºèªå¾Œï¼‰
                if (isWaitingForQRConfirmation && (normalizedText === 'ok' || normalizedWithoutSpaces === 'ok')) {
                    isWaitingForQRConfirmation = false;
                    
                    // å›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
                    isFixedQuizMode = true;
                    currentQuestionNumber = 1;
                    
                    // é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆå›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
                    addMessage('ãã‚Œã§ã¯ã€ã‚¯ã‚¤ã‚º!  ã‚¢ãƒ«ãƒ ãƒãƒ¼ãƒ†ãƒ« é–‹å§‹ï¼', 'bot');
                    
                    // 1å•ç›®ã‚’ç›´æ¥å…¨ç”»é¢è¡¨ç¤º
                    setTimeout(() => {
                        startFixedQuiz(1);
                    }, 500);
                    return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
                }
                
                // winner?ã‚’æ¤œå‡ºï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºï¼‰
                const winnerText = normalizedText.replace(/[?ï¼Ÿ]/g, '').trim();
                if (winnerText === 'winner') {
                    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã‚’é–‹ã
                    addMessage('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã—ãŸï¼', 'bot');
                    
                    // å³åº§ã«window.openã‚’å®Ÿè¡Œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã§å®Ÿè¡Œï¼‰
                    try {
                        const rankingWindow = window.open('../ranking/ranking.html', '_blank');
                        console.log('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã‚’é–‹ã“ã†ã¨ã—ã¾ã—ãŸ:', rankingWindow);
                        
                        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        if (!rankingWindow || rankingWindow.closed || typeof rankingWindow.closed === 'undefined') {
                            console.log('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãŸã‚ã€åŒã˜ã‚¿ãƒ–ã§é–‹ãã¾ã™');
                            // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰åŒã˜ã‚¿ãƒ–ã§é–‹ãï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã‚€æ™‚é–“ã‚’ä¸ãˆã‚‹ï¼‰
                            setTimeout(() => {
                                window.location.href = '../ranking/ranking.html';
                            }, 500);
                        }
                    } catch (error) {
                        console.error('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã‚’é–‹ãéš›ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚ã€åŒã˜ã‚¿ãƒ–ã§é–‹ã
                        setTimeout(() => {
                            window.location.href = '../ranking/ranking.html';
                        }, 500);
                    }
                    return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
                }
                
                if (isFixedQuizMode) {
                    // å›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ä¸­ã¯é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆã‚’ç„¡åŠ¹åŒ–
                    // ï¼ˆãŸã ã—ã€å¿µã®ãŸã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºï¼‰
                    addMessage(aiResponse, 'bot');
                    return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
                }
                
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
                // ã‚¯ã‚¤ã‚ºã‚’æ¤œå‡ºã™ã‚‹ï¼ˆJSONå½¢å¼ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
                const quizData = detectQuiz(aiResponse);
                
                if (quizData) {
                    // ã‚¯ã‚¤ã‚ºãŒæ¤œå‡ºã•ã‚ŒãŸã‚‰ã‚¯ã‚¤ã‚ºã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                    addQuizCard(quizData);
                } else {
                    // ã‚¯ã‚¤ã‚ºã§ãªã‘ã‚Œã°ï¼ˆæ™®é€šã®ä¼šè©±ãªã‚‰ï¼‰ãã®ã¾ã¾è¡¨ç¤º
                    addMessage(aiResponse, 'bot');
                }

            } catch (error) {
                console.error('API request error:', error);
                const loadingMsg = document.getElementById(loadingId);
                if(loadingMsg) loadingMsg.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒãªã©ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            }
        }

        function addMessage(text, sender, isLoading = false) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.id = isLoading ? 'loading-msg' : '';

            if (sender === 'bot') {
                // HTMLã‚¿ã‚°ï¼ˆ<br>ãªã©ï¼‰ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹ãŸã‚ã€innerHTMLã‚’ä½¿ç”¨
                // XSSå¯¾ç­–ã¨ã—ã¦ã€åŸºæœ¬çš„ãªHTMLã‚¿ã‚°ã®ã¿è¨±å¯
                const sanitizedText = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/&lt;br\s*\/?&gt;/gi, '<br>')
                    .replace(/\n/g, '<br>')
                    .replace(/<br\s*\/?>\s*<br\s*\/?>/gi, '<br>');
                div.innerHTML = `<div class="message-text">${sanitizedText}</div>`;
            } else {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¾ã¾ï¼ˆHTMLã‚¿ã‚°ã¯ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
                div.innerText = text;
            }

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div.id;
        }

        // ã‚¯ã‚¤ã‚ºã‚’æ¤œå‡ºã™ã‚‹é–¢æ•°ï¼ˆDifyãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸºã¥ããƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã‚’å„ªå…ˆï¼‰
        function detectQuiz(text) {
            // HTMLã‚¿ã‚°ã‚’ä¸€æ™‚çš„ã«ç½®æ›ã—ã¦å‡¦ç†ã—ã‚„ã™ãã™ã‚‹
            const normalizedText = text.replace(/<br\s*\/?>/gi, '\n').replace(/&nbsp;/g, ' ');
            
            // æ–¹æ³•1: JSONå½¢å¼ã‚’æ¤œå‡ºï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            try {
                let cleanJson = normalizedText.replace(/```json/g, '').replace(/```/g, '').trim();
                const quizData = JSON.parse(cleanJson);
                if (quizData.question && quizData.options && Array.isArray(quizData.options)) {
                    // correctAnswerã‚’æ­£è¦åŒ–ï¼ˆA~Då½¢å¼ã¾ãŸã¯æ•°å€¤ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¯¾å¿œï¼‰
                    if (quizData.correctAnswer !== undefined && quizData.correctAnswer !== null) {
                        if (typeof quizData.correctAnswer === 'string') {
                            const letterIndex = quizData.correctAnswer.toUpperCase().charCodeAt(0) - 'A'.charCodeAt(0);
                            if (letterIndex >= 0 && letterIndex < 4) {
                                quizData.correctAnswer = letterIndex;
                            } else {
                                quizData.correctAnswer = null;
                            }
                        } else if (typeof quizData.correctAnswer === 'number') {
                            if (quizData.correctAnswer < 0 || quizData.correctAnswer >= 4) {
                                quizData.correctAnswer = null;
                            }
                        }
                    }
                    if (quizData.options.length === 4) {
                        return quizData;
                    }
                }
            } catch (e) {
                // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯æ¬¡ã®æ–¹æ³•ã‚’è©¦ã™
            }

            // æ–¹æ³•2: Difyãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸºã¥ããƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã‚’æ¤œå‡ºï¼ˆå„ªå…ˆï¼‰
            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã¯å•é¡Œæ–‡ã®å¾Œã«é¸æŠè‚¢ãŒ<br><br>ã§åŒºåˆ‡ã‚‰ã‚Œã¦å‡ºåŠ›ã•ã‚Œã‚‹
            
            // å•é¡Œæ–‡ã‚’æ¤œå‡ºï¼ˆå†’é ­ã®ãƒ†ã‚­ã‚¹ãƒˆã€ã¾ãŸã¯ã€Œå•é¡Œ:ã€ã€ŒQ:ã€ãªã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
            let question = '';
            let questionEndIndex = 0;
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: æ˜ç¤ºçš„ãªå•é¡Œãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚‹å ´åˆ
            const questionPattern = /(?:å•é¡Œ|Q|ã‚¯ã‚¤ã‚º)[:ï¼š]\s*(.+?)(?:\n|$)/i;
            const questionMatch = normalizedText.match(questionPattern);
            if (questionMatch) {
                question = questionMatch[1].trim();
                questionEndIndex = questionMatch.index + questionMatch[0].length;
            } else {
                // ãƒ‘ã‚¿ãƒ¼ãƒ³2: é¸æŠè‚¢ã®å‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å•é¡Œæ–‡ã¨ã™ã‚‹
                // A~Dã§å§‹ã¾ã‚‹è¡Œã®å‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å•é¡Œæ–‡ã¨ã¿ãªã™
                const firstOptionMatch = normalizedText.match(/[A-D][\.ï¼ã€ï¼š\s]/i);
                if (firstOptionMatch) {
                    question = normalizedText.substring(0, firstOptionMatch.index).trim();
                    questionEndIndex = firstOptionMatch.index;
                }
            }
            
            if (!question) {
                return null;
            }
            
            // é¸æŠè‚¢ã‚’æ¤œå‡ºï¼ˆA~Då½¢å¼ã€<br><br>ã¾ãŸã¯æ”¹è¡Œã§åŒºåˆ‡ã‚‰ã‚Œã¦ã„ã‚‹ï¼‰
            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã¯ã€ŒA. é¸æŠè‚¢1<br><br>B. é¸æŠè‚¢2<br><br>...ã€ã®å½¢å¼
            const options = [];
            const optionLabels = ['A', 'B', 'C', 'D'];
            
            // æ®‹ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰é¸æŠè‚¢ã‚’æŠ½å‡º
            const remainingText = normalizedText.substring(questionEndIndex).trim();
            
            // æ–¹æ³•1: A~Då½¢å¼ã®é¸æŠè‚¢ã‚’å€‹åˆ¥ã«å³å¯†ã«æŠ½å‡º
            // å„é¸æŠè‚¢ã‚’å€‹åˆ¥ã«æŠ½å‡ºã—ã€æ˜ã‚‰ã‹ãªã‚³ãƒ¡ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§çµ‚äº†ã•ã›ã‚‹
            const foundOptions = [];
            let extractedComment = ''; // é¸æŠè‚¢Dã‹ã‚‰æŠ½å‡ºã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜
            
            // é¸æŠè‚¢ã®çµ‚äº†ã‚’æ¤œå‡ºã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã®é–‹å§‹ã‚’ç¤ºã™ï¼‰
            const commentStartKeywords = [
                'å¥½ããª', 'ç­”ãˆã¦', 'æ­£è§£', 'æ•™ãˆã¦', 'è¨€ãˆã°', 'å¿—', 'ãŠé‡‘', 'ã‚½ãƒ•ã‚£ã‚¢ãƒ³',
                'ã¡ã‚ƒã‚“ã¨', 'è§£èª¬', 'ã‚»ãƒƒãƒˆ', 'å‡ºã™', 'ã­!', 'ã­ã€‚', 'ã‚ˆã€‚', 'ã‚ˆ?',
                'ã•ã‚', 'ã©ã‚Œã ', 'â€»', 'åšå ±å ‚', 'ãƒ‘ãƒ¯ãƒ¼', 'ä¸€ç™º', 'ã„ã‘ã‚‹', 'ã§ã—ã‚‡',
                'A~D', 'A-D', '(A~D)', '(A-D)', 'ã‚’ç­”ãˆã¦', 'ã‚’é¸ã‚“ã§'
            ];
            
            // A, B, C, Dã®é †ã«é¸æŠè‚¢ã‚’æŠ½å‡º
            for (let i = 0; i < 4; i++) {
                const label = optionLabels[i];
                const labelPattern = new RegExp(`([${label}])[\.ï¼ã€ï¼š\\s]+`, 'i');
                const labelMatch = remainingText.match(labelPattern);
                
                if (!labelMatch) continue;
                
                const startIndex = labelMatch.index + labelMatch[0].length;
                let endIndex = remainingText.length;
                
                // æ¬¡ã®é¸æŠè‚¢ã®ãƒ©ãƒ™ãƒ«ã‚’æ¢ã™
                if (i < 3) {
                    const nextLabel = optionLabels[i + 1];
                    const nextLabelPattern = new RegExp(`\\n\\n+[${nextLabel}][\\.ï¼ã€ï¼š\\s]`, 'i');
                    const nextLabelMatch = remainingText.substring(startIndex).match(nextLabelPattern);
                    if (nextLabelMatch) {
                        endIndex = startIndex + nextLabelMatch.index;
                    }
                }
                
                // é¸æŠè‚¢ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
                let fullContent = remainingText.substring(startIndex, endIndex).trim();
                let content = fullContent;
                
                // ã‚³ãƒ¡ãƒ³ãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§çµ‚äº†ã•ã›ã‚‹
                let earliestCommentIndex = content.length;
                for (const keyword of commentStartKeywords) {
                    const keywordIndex = content.indexOf(keyword);
                    if (keywordIndex > 0 && keywordIndex < earliestCommentIndex) {
                        earliestCommentIndex = keywordIndex;
                    }
                }
                
                // ã‚³ãƒ¡ãƒ³ãƒˆéƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆé¸æŠè‚¢Dã®å ´åˆã®ã¿ï¼‰
                if (i === 3 && earliestCommentIndex < content.length) {
                    // é¸æŠè‚¢Dã®ã‚³ãƒ¡ãƒ³ãƒˆéƒ¨åˆ†ã‚’ä¿å­˜
                    extractedComment = content.substring(earliestCommentIndex).trim();
                    content = content.substring(0, earliestCommentIndex).trim();
                } else if (earliestCommentIndex < content.length) {
                    // ä»–ã®é¸æŠè‚¢ã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’é™¤å»
                    content = content.substring(0, earliestCommentIndex).trim();
                }
                
                // é¸æŠè‚¢ã®é•·ã•åˆ¶é™ï¼ˆ50æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯æœ€åˆã®50æ–‡å­—ã¾ã§ï¼‰
                if (content.length > 50) {
                    // å¥ç‚¹ã€ç–‘å•ç¬¦ã€æ”¹è¡Œã§åŒºåˆ‡ã£ã¦æœ€åˆã®éƒ¨åˆ†ã ã‘ã‚’å–å¾—
                    const sentences = content.split(/[ã€‚ï¼Ÿ\?\n]/);
                    if (sentences.length > 1 && sentences[0].trim().length <= 50) {
                        content = sentences[0].trim();
                    } else {
                        // 50æ–‡å­—ã¾ã§
                        content = content.substring(0, 50).trim();
                        // æœ€å¾Œã®å¥ç‚¹ã¾ã§
                        const lastPeriod = content.lastIndexOf('ã€‚');
                        if (lastPeriod > 0) {
                            content = content.substring(0, lastPeriod + 1);
                        }
                    }
                }
                
                // ä½™åˆ†ãªæ”¹è¡Œã‚„ç©ºç™½ã‚’æ•´ç†
                content = content.replace(/\n+/g, ' ').replace(/\s+/g, ' ').trim();
                
                // é¸æŠè‚¢ãŒç©ºã§ãªã„å ´åˆã®ã¿è¿½åŠ 
                if (content && content.length > 0) {
                    foundOptions.push({
                        label: label,
                        content: content,
                        index: i
                    });
                }
            }
            
            // ãƒ©ãƒ™ãƒ«é †ï¼ˆA, B, C, Dï¼‰ã«ã‚½ãƒ¼ãƒˆ
            foundOptions.sort((a, b) => a.index - b.index);
            
            // 4ã¤ã®é¸æŠè‚¢ãŒé †ç•ªã«æƒã£ã¦ã„ã‚‹ã‹ç¢ºèª
            if (foundOptions.length === 4) {
                // ã™ã¹ã¦A, B, C, Dã®é †ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
                const isSequential = foundOptions.every((opt, idx) => opt.index === idx);
                if (isSequential) {
                    options.push(...foundOptions.map(opt => opt.content));
                }
            }
            
            // æ–¹æ³•2: ã‚‚ã—ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã§4ã¤è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã€æ”¹è¡ŒåŒºåˆ‡ã‚Šã§è©¦ã™
            if (options.length < 4) {
                // <br><br>ã‚„æ”¹è¡Œã§åŒºåˆ‡ã‚‰ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’é¸æŠè‚¢ã¨ã¿ãªã™
                const blocks = remainingText.split(/\n\n+/).filter(block => block.trim().length > 0);
                for (let i = 0; i < Math.min(blocks.length, 4); i++) {
                    const block = blocks[i].trim();
                    // A~Dã®ãƒ©ãƒ™ãƒ«ã‚’é™¤å»ã—ã¦å†…å®¹ã ã‘ã‚’å–å¾—
                    const cleanBlock = block.replace(/^[A-D][\.ï¼ã€ï¼š\s]+/i, '').trim()
                        .replace(/\n+/g, ' ')
                        .replace(/\s+/g, ' ');
                    if (cleanBlock && options.length < 4) {
                        if (options.length === 0 || !options.includes(cleanBlock)) {
                            options.push(cleanBlock);
                        }
                    }
                }
            }
            
            // é¸æŠè‚¢ãŒ4ã¤æƒã£ã¦ã„ã‚‹ã‹ç¢ºèª
            if (options.length === 4) {
                // æ­£è§£ã‚’æ¤œå‡ºï¼ˆã€Œæ­£è§£ï¼š[è¨˜å·]ã€ã®å½¢å¼ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸºã¥ãï¼‰
                let correctAnswer = null;
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã€Œæ­£è§£ï¼šAã€å½¢å¼
                const answerPattern1 = /æ­£è§£[:ï¼š]\s*([A-D])/i;
                const answerMatch1 = normalizedText.match(answerPattern1);
                if (answerMatch1) {
                    const letter = answerMatch1[1].toUpperCase();
                    correctAnswer = letter.charCodeAt(0) - 'A'.charCodeAt(0);
                } else {
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã€Œç­”ãˆï¼šAã€å½¢å¼
                    const answerPattern2 = /ç­”ãˆ[:ï¼š]\s*([A-D])/i;
                    const answerMatch2 = normalizedText.match(answerPattern2);
                    if (answerMatch2) {
                        const letter = answerMatch2[1].toUpperCase();
                        correctAnswer = letter.charCodeAt(0) - 'A'.charCodeAt(0);
                    }
                }
                
                // è§£èª¬ã‚’æ¤œå‡ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã¯ã€Œè§£èª¬ï¼š<br>[è©³ã—ã„è§£èª¬]ã€å½¢å¼ï¼‰
                let explanation = '';
                const explanationPattern = /è§£èª¬[:ï¼š]\s*(.+?)(?:\n\n|\næ­£è§£|$)/is;
                const explanationMatch = normalizedText.match(explanationPattern);
                if (explanationMatch) {
                    explanation = explanationMatch[1].trim()
                        .replace(/\n+/g, ' ')
                        .replace(/\s+/g, ' ')
                        .replace(/<br\s*\/?>/gi, ' ');
                }
                
                // é¸æŠè‚¢Dã‹ã‚‰æŠ½å‡ºã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’å•é¡Œæ–‡ã«è¿½åŠ 
                const quizData = {
                    question: question,
                    options: options,
                    correctAnswer: correctAnswer,
                    explanation: explanation
                };
                
                // é¸æŠè‚¢Dã‹ã‚‰æŠ½å‡ºã—ãŸã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã€å•é¡Œæ–‡ã«è¿½åŠ 
                if (extractedComment && extractedComment.length > 0) {
                    quizData.extractedComment = extractedComment;
                }
                
                return quizData;
            }
            
            return null;
        }

        function addQuizCard(quizData) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = 'message bot';
            
            // ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆå…¨ç”»é¢è¡¨ç¤ºæ™‚ã«ä½¿ç”¨ï¼‰
            const quizId = 'quiz-' + Date.now();
            div.dataset.quizId = quizId;
            window[quizId] = quizData;
            
            // å•é¡Œæ–‡ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆHTMLã‚¿ã‚°ã‚’é™¤å»ï¼‰
            const safeQuestion = quizData.question
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/<br\s*\/?>/gi, ' ')
                .trim();
            const displayQuestion = safeQuestion.length > 50 ? safeQuestion.substring(0, 50) + '...' : safeQuestion;
            
            div.innerHTML = `
                <div class="message-text">
                    <div class="quiz-card" onclick="startQuiz('${quizId}')">
                        <h3>ğŸ¯ ã‚¯ã‚¤ã‚ºãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼</h3>
                        <p>${displayQuestion}</p>
                        <button>å…¨ç”»é¢ã§è¡¨ç¤ºã™ã‚‹</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // å›ºå®šã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ï¼ˆå›ºå®šã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å•é¡Œã‚’è¡¨ç¤ºï¼‰
        async function startFixedQuiz(questionNumber) {
            if (questionNumber < 1 || questionNumber > fixedQuizQuestions.length) {
                return;
            }
            
            // ç¬¬1å•ã®å ´åˆã¯ã‚¯ã‚¤ã‚ºéŸ³æ¥½ã‚’é–‹å§‹
            if (questionNumber === 1) {
                startQuizMusic();
            }
            
            const questionData = fixedQuizQuestions[questionNumber - 1];
            currentQuestionNumber = questionNumber;
            
            // Firebaseã«ç¾åœ¨ã®å•é¡Œç•ªå·ã‚’è¨­å®šï¼ˆå‚åŠ è€…ãƒ•ã‚©ãƒ¼ãƒ ã¨ã®åŒæœŸï¼‰
            try {
                const quizRef = database.ref('quizzes/current');
                
                // ç¬¬1å•ã®å ´åˆã¯ã€ã‚¯ã‚¤ã‚ºã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
                if (questionNumber === 1) {
                    const sessionId = 'quiz-' + Date.now();
                    currentQuizSessionId = sessionId;
                    
                    // â˜…é‡è¦ï¼šæœ¬ç•ªå‰ã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                    // æ—¢å­˜ã®participantsãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ï¼‰
                    const participantsRef = database.ref('quizzes/current/participants');
                    await participantsRef.remove();
                    
                    // æ—¢å­˜ã®questionsãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ï¼ˆå¿µã®ãŸã‚ï¼‰
                    const questionsRef = database.ref('quizzes/current/questions');
                    await questionsRef.remove();
                    
                    // ã‚¯ã‚¤ã‚ºã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
                    await quizRef.set({
                        currentQuestion: 1,
                        status: 'active',
                        sessionId: sessionId,
                        startedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // ç¬¬1å•ã®æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
                    const questionRef = database.ref(`quizzes/current/questions/1`);
                    await questionRef.set({
                        votes: {
                            A: 0,
                            B: 0,
                            C: 0,
                            D: 0
                        },
                        totalVotes: 0
                    });
                } else {
                    // 2å•ç›®ä»¥é™ã¯å•é¡Œç•ªå·ã®ã¿æ›´æ–°
                    await quizRef.update({
                        currentQuestion: questionNumber
                    });
                    
                    // æ–°ã—ã„å•é¡Œã®æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
                    const questionRef = database.ref(`quizzes/current/questions/${questionNumber}`);
                    await questionRef.set({
                        votes: {
                            A: 0,
                            B: 0,
                            C: 0,
                            D: 0
                        },
                        totalVotes: 0
                    });
                }
            } catch (error) {
                console.error('Firebaseæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¯ã‚¤ã‚ºã¯è¡¨ç¤ºã™ã‚‹
            }
            
            // ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
            const quizData = {
                question: `${questionData.intro ? questionData.intro + '<br>' : ''}ã€å•é¡Œã€‘<br>${questionData.question}`,
                options: questionData.options,
                correctAnswer: questionData.correctAnswer,
                explanation: questionData.explanation,
                intro: questionData.intro,
                mainQuestion: questionData.question,
                comment: questionData.comment,
                images: questionData.images || [],
                imageScale: questionData.imageScale || 1.0
            };
            
            // å…¨ç”»é¢è¡¨ç¤º
            await startQuiz(quizData);
            
            // æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
            listenToVotes(questionNumber);
        }
        
        // ===== æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– =====
        function listenToVotes(questionNumber) {
            if (!questionNumber || questionNumber < 1 || questionNumber > fixedQuizQuestions.length) {
                return;
            }
            
            // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
            if (currentVoteListener) {
                database.ref(`quizzes/current/questions/${questionNumber}/votes`).off('value', currentVoteListener);
                database.ref(`quizzes/current/questions/${questionNumber}/totalVotes`).off('value', currentVoteListener);
                currentVoteListener = null;
            }
            
            const votesRef = database.ref(`quizzes/current/questions/${questionNumber}/votes`);
            const totalVotesRef = database.ref(`quizzes/current/questions/${questionNumber}/totalVotes`);
            
            // æŠ•ç¥¨æ•°ã®å¤‰æ›´ã‚’ç›£è¦–
            const updateVotePercentages = () => {
                Promise.all([
                    votesRef.once('value'),
                    totalVotesRef.once('value')
                ]).then(([votesSnapshot, totalSnapshot]) => {
                    const votes = votesSnapshot.val() || { A: 0, B: 0, C: 0, D: 0 };
                    const totalVotes = totalSnapshot.val() || 0;
                    
                    // å„é¸æŠè‚¢ã®æŠ•ç¥¨ç‡ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
                    const optionLabels = ['A', 'B', 'C', 'D'];
                    optionLabels.forEach(label => {
                        const voteCount = votes[label] || 0;
                        const percentage = totalVotes > 0 ? Math.round((voteCount / totalVotes) * 100) : 0;
                        
                        const percentageElement = document.getElementById(`vote-percentage-${label}`);
                        if (percentageElement) {
                            percentageElement.textContent = `${percentage}%`;
                        }
                    });
                }).catch((error) => {
                    console.error('æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
            };
            
            // åˆæœŸè¡¨ç¤º
            updateVotePercentages();
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
            currentVoteListener = votesRef.on('value', updateVotePercentages);
            totalVotesRef.on('value', updateVotePercentages);
        }
        
        // å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã‚’èµ·å‹•
        async function startQuiz(quizIdOrData) {
            const data = typeof quizIdOrData === 'string' ? window[quizIdOrData] : quizIdOrData;
            currentQuizData = data;
            quizAnswered = false;
            timeRemaining = 60;
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
            const overlay = document.getElementById('quiz-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('show'), 10);
            
            // å•é¡Œæ–‡ã‚’å‰å£ä¸Šã¨å®Ÿéš›ã®å•é¡Œã«åˆ†é›¢
            const questionText = data.question;
            let introText = '';
            let mainQuestion = questionText;
            
            // å›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç›´æ¥introã¨mainQuestionã‚’ä½¿ç”¨
            if (isFixedQuizMode && data.intro && data.mainQuestion) {
                introText = data.intro;
                mainQuestion = data.mainQuestion;
            } else {
                // å•é¡Œæ–‡ã‚’è§£æã—ã¦å‰å£ä¸Šã‚’æ¤œå‡º
                // ã€å•é¡Œã€‘ãƒãƒ¼ã‚«ãƒ¼ã§åŒºåˆ‡ã‚‹ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿®æ­£ç‰ˆã«å¯¾å¿œï¼‰
                const problemMarker = /ã€å•é¡Œã€‘/;
                const markerMatch = questionText.match(problemMarker);
                
                if (markerMatch) {
                    // ã€å•é¡Œã€‘ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ
                    const markerIndex = markerMatch.index;
                    introText = questionText.substring(0, markerIndex).trim();
                    // ã€å•é¡Œã€‘ãƒãƒ¼ã‚«ãƒ¼ã‚’é™¤å»ã—ã¦å•é¡Œæ–‡ã‚’å–å¾—
                    mainQuestion = questionText.substring(markerIndex + markerMatch[0].length).trim();
                } else {
                    // ã€å•é¡Œã€‘ãƒãƒ¼ã‚«ãƒ¼ãŒãªã„å ´åˆã€å¾“æ¥ã®æ–¹æ³•ã§æ¤œå‡ºï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
                    const introPatterns = [
                        /^(.+?)(ã•ã‚[ã€,].+?[ã€‚\n])/i,
                        /^(.+?)(ãã‚Œã§ã¯.+?[ã€‚\n])/i,
                        /^(.+?)(ã§ã¯.+?[ã€‚\n])/i
                    ];
                    
                    for (const pattern of introPatterns) {
                        const match = questionText.match(pattern);
                        if (match && match[1] && match[2]) {
                            introText = match[1].trim();
                            mainQuestion = questionText.substring(match[0].length).trim();
                            break;
                        }
                    }
                    
                    // å‰å£ä¸ŠãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœ€åˆã®æ–‡ã‚’å‰å£ä¸Šã¨ã—ã¦æ‰±ã†ï¼ˆçŸ­ã„å ´åˆï¼‰
                    if (!introText && questionText.length > 50) {
                        const firstSentence = questionText.split(/[ã€‚\n]/)[0];
                        if (firstSentence.length < 30 && firstSentence.length > 0) {
                            introText = firstSentence + 'ã€‚';
                            mainQuestion = questionText.substring(introText.length).trim();
                        }
                    }
                }
            }
            
            // HTMLã‚¿ã‚°ã‚’é©åˆ‡ã«å‡¦ç†
            const safeIntro = introText
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/&lt;br\s*\/?&gt;/gi, '<br>')
                .replace(/\n/g, '<br>');
            const safeMain = mainQuestion
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/&lt;br\s*\/?&gt;/gi, '<br>')
                .replace(/\n/g, '<br>');
            
            // å•é¡Œã‚¨ãƒªã‚¢ã‚’è¨­å®š
            const questionElement = document.getElementById('quiz-question');
            const questionWrapper = document.getElementById('quiz-question-wrapper');
            const questionIntro = document.getElementById('quiz-question-intro');
            const questionMain = document.getElementById('quiz-question-main');
            const questionComment = document.getElementById('quiz-question-comment');
            const questionNumber = document.getElementById('quiz-question-number');
            const timerElement = document.getElementById('quiz-timer');
            
            // å•é¡Œè¡¨ç¤ºå‰ã«è¦ç´ ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢ï¼ˆä¸€ç¬ã®è¡¨ç¤ºã‚’é˜²ãï¼‰
            // ã¾ãšã€quiz-questionã‚’ç”»é¢å¤–ã«ç§»å‹•ã—ã¦éè¡¨ç¤ºã«ã™ã‚‹
            if (questionElement) {
                // ç¢ºå®Ÿã«ç”»é¢å¤–ã«ç§»å‹•ã—ã¦éè¡¨ç¤ºã«ã™ã‚‹
                questionElement.classList.add('hidden');
                questionElement.style.animation = 'none';
                // å¼·åˆ¶çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å¾…ã¤
                questionElement.offsetHeight; // ãƒªãƒ•ãƒ­ãƒ¼ã‚’å¼·åˆ¶
                // ã•ã‚‰ã«å¾…ã¤
                await new Promise(resolve => requestAnimationFrame(resolve));
            }
            if (questionMain) {
                questionMain.innerHTML = '';
            }
            if (questionIntro) {
                questionIntro.innerHTML = '';
                questionIntro.style.display = 'none';
            }
            if (questionComment) {
                questionComment.innerHTML = '';
                questionComment.style.display = 'none';
            }
            if (questionNumber) {
                questionNumber.innerHTML = '';
            }
            
            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ç¢ºå®Ÿã«ã™ã‚‹ï¼ˆè¤‡æ•°å›å¾…ã¤ï¼‰
            await new Promise(resolve => requestAnimationFrame(resolve));
            await new Promise(resolve => requestAnimationFrame(resolve));
            
            // å›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ä¸­ã®å ´åˆã€å•é¡Œç•ªå·ã‚’è¡¨ç¤º
            if (isFixedQuizMode && questionNumber) {
                questionNumber.textContent = `ç¬¬${currentQuestionNumber}å• / å…¨${fixedQuizQuestions.length}å•`;
                questionNumber.style.display = 'block';
            } else if (questionNumber) {
                questionNumber.style.display = 'none';
            }
            
            if (questionIntro && questionMain && timerElement) {
                // å‰å£ä¸Šã‚’è¨­å®š
                const hasIntro = safeIntro && safeIntro.trim().length > 0;
                if (hasIntro) {
                    questionIntro.innerHTML = safeIntro;
                    questionIntro.style.display = 'block';
                } else {
                    questionIntro.style.display = 'none';
                }
                
                // å®Ÿéš›ã®å•é¡Œã‚’è¨­å®š
                questionMain.innerHTML = safeMain;
                
                // å•é¡Œæ–‡ã®è‰²ã‚’ç™½è‰²ã«çµ±ä¸€
                questionMain.style.color = 'white';
                
                // Q2ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’5%ä¸‹ã’ã‚‹
                if (isFixedQuizMode && currentQuestionNumber === 2) {
                    questionMain.style.fontSize = 'clamp(1.71em, 3.8vw, 2.66em)';
                } else {
                    questionMain.style.fontSize = 'clamp(1.8em, 4vw, 2.8em)';
                }
                
                // é¸æŠè‚¢Dã‹ã‚‰æŠ½å‡ºã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’å•é¡Œæ–‡ã«è¿½åŠ ï¼ˆå°ã•ã„æ–‡å­—ã‚µã‚¤ã‚ºï¼‰
                // å›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€commentãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯è¡¨ç¤ºã—ãªã„ï¼ˆå•é¡Œæ–‡ã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰
                // ãŸã ã—ã€extractedCommentãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤ºã™ã‚‹ï¼ˆDifyã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸã‚¯ã‚¤ã‚ºã®å ´åˆï¼‰
                if (data.extractedComment && questionComment) {
                    const safeComment = data.extractedComment
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/&lt;br\s*\/?&gt;/gi, '<br>')
                        .replace(/\n/g, '<br>');
                    questionComment.innerHTML = safeComment;
                    questionComment.style.display = 'block';
                } else if (questionComment) {
                    questionComment.style.display = 'none';
                }
                
                // ã‚¿ã‚¤ãƒãƒ¼ã‚’å•é¡Œãƒ‘ãƒãƒ«ã®ä¸Šã«é…ç½®
                timerElement.style.cssText = 'position: absolute !important; top: -70px !important; right: 20px !important; display: block !important;';
                
                // ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                timerElement.textContent = timeRemaining;
                timerElement.classList.remove('warning');
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®æ–¹æ³•
                questionElement.innerHTML = '<div id="quiz-timer">' + timeRemaining + '</div>' + safeMain;
                const fallbackTimer = document.getElementById('quiz-timer');
                if (fallbackTimer) {
                    fallbackTimer.textContent = timeRemaining;
                    fallbackTimer.classList.remove('warning');
                }
            }
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
            startTimer();
            
            // ã™ã¹ã¦ã®å†…å®¹ã‚’è¨­å®šã—ãŸå¾Œã€quiz-questionã‚’è¡¨ç¤ºï¼ˆä¸€ç¬ã®è¡¨ç¤ºã‚’é˜²ãï¼‰
            if (questionElement) {
                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã«è¤‡æ•°å›å¾…ã¤
                await new Promise(resolve => requestAnimationFrame(resolve));
                await new Promise(resolve => requestAnimationFrame(resolve));
                await new Promise(resolve => requestAnimationFrame(resolve));
                
                // hiddenã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã—ã¦æ­£ã—ã„ä½ç½®ã«æˆ»ã™ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç„¡åŠ¹åŒ–ã—ãŸã¾ã¾ï¼‰
                questionElement.style.animation = 'none';
                questionElement.style.position = 'relative'; // æ­£ã—ã„ä½ç½®ã«æˆ»ã™
                questionElement.style.left = '';
                questionElement.style.top = '';
                questionElement.classList.remove('hidden');
                
                // å¼·åˆ¶çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å¾…ã¤
                questionElement.offsetHeight; // ãƒªãƒ•ãƒ­ãƒ¼ã‚’å¼·åˆ¶
                
                // ã•ã‚‰ã«å¾…ã¤
                await new Promise(resolve => requestAnimationFrame(resolve));
                
                // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†æœ‰åŠ¹åŒ–ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œï¼‰
                await new Promise(resolve => requestAnimationFrame(resolve));
                questionElement.style.animation = 'fadeInUp 0.5s ease-out';
            }
            
            // å•é¡Œã«é–¢é€£ã™ã‚‹ç”»åƒã‚’æ¤œç´¢ã—ã¦è¡¨ç¤º
            const imageContainer = document.getElementById('quiz-image-container');
            const imageElement = document.getElementById('quiz-image');
            const imageUrl = await searchQuizImage(data.question);
            if (imageUrl) {
                imageElement.src = imageUrl;
                imageElement.onerror = () => {
                    imageContainer.style.display = 'none';
                };
                imageContainer.style.display = 'block';
            } else {
                imageContainer.style.display = 'none';
            }
            
            // é¸æŠè‚¢ã‚’è¡¨ç¤ºï¼ˆA~Då½¢å¼ã§è¡¨ç¤ºï¼‰
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            optionsContainer.style.display = 'grid'; // ã‚¯ã‚¤ã‚ºè¡¨ç¤ºæ™‚ã¯è¡¨ç¤º
            
            // é¸æŠè‚¢ãŒ4ã¤ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
            if (!data.options || data.options.length !== 4) {
                console.error('ã‚¯ã‚¤ã‚ºã®é¸æŠè‚¢ã¯4ã¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                return;
            }
            
            const optionLabels = ['A', 'B', 'C', 'D'];
            data.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                // é¸æŠè‚¢ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆHTMLã‚¿ã‚°ã‚’é™¤å»ï¼‰
                const safeOpt = opt
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/<br\s*\/?>/gi, ' ')
                    .trim();
                
                // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”¨ã®divã‚’ä½œæˆ
                const contentDiv = document.createElement('div');
                contentDiv.className = 'option-btn-content';
                
                // ãƒ©ãƒ™ãƒ«ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†ã‘ã¦è¡¨ç¤º
                const labelSpan = document.createElement('span');
                labelSpan.className = 'option-label';
                labelSpan.textContent = optionLabels[index];
                contentDiv.appendChild(labelSpan);
                
                const textSpan = document.createElement('span');
                textSpan.textContent = safeOpt;
                contentDiv.appendChild(textSpan);
                
                btn.appendChild(contentDiv);
                
                // æŠ•ç¥¨ç‡è¡¨ç¤ºç”¨ã®è¦ç´ ã‚’è¿½åŠ 
                const percentageSpan = document.createElement('span');
                percentageSpan.className = 'option-vote-percentage';
                percentageSpan.id = `vote-percentage-${optionLabels[index]}`;
                percentageSpan.textContent = '0%';
                btn.appendChild(percentageSpan);
                
                btn.dataset.index = index;
                btn.dataset.label = optionLabels[index];
                btn.onclick = () => selectAnswer(index, safeOpt, optionLabels[index]);
                optionsContainer.appendChild(btn);
            });
            
            // å›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
            if (isFixedQuizMode && currentQuestionNumber >= 1 && currentQuestionNumber <= 10) {
                listenToVotes(currentQuestionNumber);
            }
            
            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨èª¬æ˜ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆéè¡¨ç¤ºã«ã™ã‚‹ï¼‰
            const feedbackDiv = document.getElementById('quiz-feedback');
            const explanationDiv = document.getElementById('quiz-explanation');
            const actionsDiv = document.getElementById('quiz-actions');
            
            if (feedbackDiv) {
                feedbackDiv.innerHTML = '';
                feedbackDiv.className = '';
                feedbackDiv.style.display = 'none';
            }
            if (explanationDiv) {
                explanationDiv.innerHTML = '';
                explanationDiv.style.display = 'none';
            }
            if (actionsDiv) {
                actionsDiv.innerHTML = '';
                actionsDiv.style.display = 'none';
            }
            
            // é¸æŠè‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå‰å›ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ï¼‰
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                btn.classList.remove('disabled', 'correct', 'incorrect', 'show-correct');
                btn.style.border = '';
                btn.style.backgroundColor = '';
            });
        }

        // å›ç­”ã‚’é¸æŠã—ãŸã¨ãã®å‡¦ç†
        async function selectAnswer(selectedIndex, selectedText, selectedLabel) {
            if (quizAnswered) return;
            quizAnswered = true;
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
            stopTimer();
            
            const buttons = document.querySelectorAll('.option-btn');
            const actionsDiv = document.getElementById('quiz-actions');
            
            // é¸æŠã—ãŸãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            buttons.forEach((btn, idx) => {
                if (idx === selectedIndex) {
                    btn.style.border = '3px solid #ffeb3b';
                    btn.style.backgroundColor = 'rgba(255, 235, 59, 0.2)';
                    btn.style.boxShadow = '0 0 30px rgba(255, 235, 59, 0.8)';
                } else {
                    btn.classList.add('disabled');
                }
            });
            
                // é¸æŠã—ãŸå›ç­”ã‚’ä¿å­˜
            currentQuizData.selectedAnswer = {
                index: selectedIndex,
                text: selectedText,
                label: selectedLabel
            };
            
            // å›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ã€ã™ãã«ãƒ­ãƒ¼ã‚«ãƒ«ã§åˆ¤å®š
            if (isFixedQuizMode) {
                checkFixedQuizAnswer(selectedIndex);
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¯ã€Œå›ç­”ã‚’é€ä¿¡ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                // é¸æŠã—ãŸãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’é€ä¿¡ï¼ˆãƒ©ãƒ™ãƒ«ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†é›¢ï¼‰
                const cleanSelectedText = currentQuizData.options[selectedIndex].trim();
                const answerToSend = cleanSelectedText; // ç›´æ¥é¸æŠè‚¢ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨
                actionsDiv.style.display = 'flex';
                actionsDiv.innerHTML = `
                    <button class="quiz-action-btn" onclick="sendQuizAnswer('${selectedLabel}. ${answerToSend.replace(/'/g, "\\'").replace(/"/g, '&quot;')}')">
                        å›ç­”ã‚’é€ä¿¡ã™ã‚‹
                    </button>
                    <button class="quiz-action-btn" onclick="closeQuiz()">
                        é–‰ã˜ã‚‹
                    </button>
                `;
            }
        }
        
        // å›ºå®šã‚¯ã‚¤ã‚ºã®å›ç­”ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§åˆ¤å®š
        function checkFixedQuizAnswer(selectedIndex) {
            if (!currentQuizData || currentQuizData.correctAnswer === undefined) {
                return;
            }
            
            const isCorrect = selectedIndex === currentQuizData.correctAnswer;
            const correctLabel = ['A', 'B', 'C', 'D'][currentQuizData.correctAnswer];
            const correctOptionText = currentQuizData.options && currentQuizData.options[currentQuizData.correctAnswer] ? currentQuizData.options[currentQuizData.correctAnswer] : '';
            const explanation = currentQuizData.explanation || '';
            const images = currentQuizData.images || [];
            const imageScale = currentQuizData.imageScale || 1.0;
            
            // é¸æŠè‚¢ã®ãƒœã‚¿ãƒ³ã‚’æ›´æ–°ï¼ˆæ­£è§£ãƒ»ä¸æ­£è§£ã®è¡¨ç¤ºï¼‰
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, idx) => {
                btn.classList.add('disabled');
                if (idx === currentQuizData.correctAnswer) {
                    btn.classList.add('correct', 'show-correct');
                    btn.style.border = '3px solid #4caf50';
                    btn.style.backgroundColor = 'rgba(76, 175, 80, 0.3)';
                } else if (idx === selectedIndex && !isCorrect) {
                    btn.classList.add('incorrect');
                    btn.style.border = '3px solid #f44336';
                    btn.style.backgroundColor = 'rgba(244, 67, 54, 0.3)';
                }
            });
            
            // çµæœç”»é¢ã‚’è¡¨ç¤º
            showFixedQuizResult(isCorrect, correctLabel, correctOptionText, explanation, images, imageScale);
        }
        
        // å›ºå®šã‚¯ã‚¤ã‚ºã®çµæœç”»é¢ã‚’è¡¨ç¤º
        function showFixedQuizResult(isCorrect, correctLabel, correctOptionText, explanation, images = [], imageScale = 1.0) {
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’éè¡¨ç¤º
            const timerElement = document.getElementById('quiz-timer');
            if (timerElement) {
                timerElement.style.display = 'none';
            }
            
            // Firebaseã«å•é¡Œã‚’ç· ã‚åˆ‡ã‚‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆæ­£è§£è¡¨ç¤ºæ™‚ç‚¹ã§å›ç­”ç· ã‚åˆ‡ã‚Šï¼‰
            if (currentQuestionNumber >= 1 && currentQuestionNumber <= fixedQuizQuestions.length) {
                try {
                    database.ref(`quizzes/current/questions/${currentQuestionNumber}`).update({
                        closed: true,
                        closedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                } catch (error) {
                    console.error('Firebaseæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            // å•é¡Œã‚¨ãƒªã‚¢ã«åˆ¤å®šã‚’è¡¨ç¤º
            const questionWrapper = document.getElementById('quiz-question-wrapper');
            const questionIntro = document.getElementById('quiz-question-intro');
            const questionMain = document.getElementById('quiz-question-main');
            const questionComment = document.getElementById('quiz-question-comment');
            
            // å‰å£ä¸Šã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’éè¡¨ç¤º
            if (questionIntro) questionIntro.style.display = 'none';
            if (questionComment) questionComment.style.display = 'none';
            
            // åˆ¤å®šã‚’è¡¨ç¤ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆã¨ç”»åƒã‚’æ¨ªä¸¦ã³ã«ï¼‰
            if (questionMain) {
                const judgment = isCorrect ? 'æ­£è§£ï¼' : 'æ®‹å¿µã€ä¸æ­£è§£ï¼';
                const imagePath = isCorrect ? 'assets/maru.png' : 'assets/batsu.png';
                const imageAlt = isCorrect ? 'æ­£è§£' : 'ä¸æ­£è§£';
                questionMain.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 2vw;">
                        <img src="${imagePath}" alt="${imageAlt}" class="quiz-result-image">
                        <div style="font-size: clamp(2rem, 4vw, 3.5rem); color: ${isCorrect ? '#4caf50' : '#f44336'};">
                            ${judgment}
                        </div>
                    </div>
                `;
                questionMain.style.fontSize = 'clamp(2rem, 4vw, 3.5rem)';
                questionMain.style.textAlign = 'center';
                questionMain.style.color = isCorrect ? '#4caf50' : '#f44336';
            }
            
            // é¸æŠè‚¢ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.style.display = 'none';
            
            // æ­£è§£ã¨è§£èª¬ã‚’è¡¨ç¤º
            const feedbackDiv = document.getElementById('quiz-feedback');
            const explanationDiv = document.getElementById('quiz-explanation');
            
            if (feedbackDiv) {
                const correctText = correctOptionText ? `æ­£è§£ï¼š${correctLabel} ${correctOptionText}` : `æ­£è§£ï¼š${correctLabel}`;
                feedbackDiv.innerHTML = correctText;
                feedbackDiv.style.display = 'block';
                feedbackDiv.className = isCorrect ? 'correct' : 'incorrect';
            }
            
            if (explanationDiv) {
                // è§£èª¬æ–‡ã¨ç”»åƒã‚’çµ„ã¿åˆã‚ã›ã¦è¡¨ç¤º
                let explanationHtml = explanation.replace(/\n/g, '<br>');
                
                // ç”»åƒãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
                if (images && images.length > 0) {
                    // ç”»åƒã‚’æ‹¡å¤§ã™ã‚‹å ´åˆã€å®Ÿéš›ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨
                    const imagesHtml = images.map((img, index) => {
                        const isLastImage = index === images.length - 1;
                        const scaleStyle = imageScale !== 1.0 
                            ? `style="transform: scale(${imageScale}); transform-origin: center top; display: block; margin: 2vh auto;"` 
                            : `style="display: block; margin: 2vh auto;"`;
                        
                        // æœ€å¾Œã®ç”»åƒã®ä¸‹ã«ååˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ï¼ˆæ‹¡å¤§ç‡ã«å¿œã˜ã¦ï¼‰
                        let imageWithSpacer = `<img src="${img}" alt="è§£èª¬ç”»åƒ" ${scaleStyle}>`;
                        if (isLastImage && imageScale > 1.0) {
                            // æ‹¡å¤§ã•ã‚ŒãŸç”»åƒã®ä¸‹ã«ã‚¹ãƒšãƒ¼ã‚µãƒ¼ã‚’è¿½åŠ 
                            const spacerHeight = `${(imageScale - 1) * 30 + 10}vh`;
                            imageWithSpacer += `<div style="height: ${spacerHeight}; display: block;"></div>`;
                        } else if (isLastImage) {
                            // é€šå¸¸ã‚µã‚¤ã‚ºã§ã‚‚ä¸‹ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿
                            imageWithSpacer += `<div style="height: 5vh; display: block;"></div>`;
                        }
                        
                        return imageWithSpacer;
                    }).join('<br>'); // ç”»åƒã®é–“ã«æ”¹è¡Œã‚’è¿½åŠ 
                    
                    // è§£èª¬æ–‡ãŒç©ºã®å ´åˆã¯ç”»åƒã®ã¿ã€ãã†ã§ãªã„å ´åˆã¯è§£èª¬æ–‡ã®å¾Œã«ç”»åƒ
                    if (explanation.trim() === '') {
                        explanationHtml = imagesHtml;
                    } else {
                        explanationHtml = explanationHtml + '<br>' + imagesHtml;
                    }
                }
                
                explanationDiv.innerHTML = explanationHtml;
                explanationDiv.style.display = 'block';
            }
            
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const actionsDiv = document.getElementById('quiz-actions');
            if (actionsDiv) {
                actionsDiv.style.display = 'flex';
                
                // æœ€å¾Œã®å•é¡Œã‹ã©ã†ã‹ã§ãƒœã‚¿ãƒ³ã‚’å¤‰ãˆã‚‹
                if (currentQuestionNumber >= fixedQuizQuestions.length) {
                    // æœ€å¾Œã®å•é¡Œï¼šçµ‚äº†ãƒœã‚¿ãƒ³ã®ã¿
                    actionsDiv.innerHTML = `
                        <button class="quiz-action-btn" onclick="endFixedQuiz()">
                            ã‚¯ã‚¤ã‚ºçµ‚äº†
                        </button>
                    `;
                } else {
                    // æ¬¡ã®å•é¡Œã¸é€²ã‚€ãƒœã‚¿ãƒ³
                    actionsDiv.innerHTML = `
                        <button class="quiz-action-btn" onclick="nextFixedQuizQuestion()">
                            æ¬¡ã®å•é¡Œã¸
                        </button>
                    `;
                }
            }
        }
        
        // æ¬¡ã®å•é¡Œã«é€²ã‚€
        async function nextFixedQuizQuestion() {
            // å‰ã®å•é¡Œã®çµæœç”»é¢ã‚’å³åº§ã«éè¡¨ç¤ºã«ã™ã‚‹
            const feedbackDiv = document.getElementById('quiz-feedback');
            const explanationDiv = document.getElementById('quiz-explanation');
            const actionsDiv = document.getElementById('quiz-actions');
            const questionElement = document.getElementById('quiz-question');
            const questionMain = document.getElementById('quiz-question-main');
            const questionIntro = document.getElementById('quiz-question-intro');
            const questionComment = document.getElementById('quiz-question-comment');
            const questionNumber = document.getElementById('quiz-question-number');
            const optionsContainer = document.getElementById('quiz-options');
            
            // ã™ã¹ã¦ã®è¦ç´ ã‚’å³åº§ã«éè¡¨ç¤ºã«ã—ã¦å†…å®¹ã‚’ã‚¯ãƒªã‚¢
            if (feedbackDiv) {
                feedbackDiv.style.display = 'none';
                feedbackDiv.innerHTML = '';
            }
            if (explanationDiv) {
                explanationDiv.style.display = 'none';
                explanationDiv.innerHTML = '';
            }
            if (actionsDiv) {
                actionsDiv.style.display = 'none';
                actionsDiv.innerHTML = '';
            }
            // quiz-questionã‚’å®Œå…¨ã«éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰å†…å®¹ã‚’ã‚¯ãƒªã‚¢
            if (questionElement) {
                // å³åº§ã«ç”»é¢å¤–ã«ç§»å‹•ã—ã¦éè¡¨ç¤ºã«ã™ã‚‹
                questionElement.classList.add('hidden');
                questionElement.style.animation = 'none';
                // å¼·åˆ¶çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å¾…ã¤
                questionElement.offsetHeight; // ãƒªãƒ•ãƒ­ãƒ¼ã‚’å¼·åˆ¶
                // ã•ã‚‰ã«å¾…ã¤
                await new Promise(resolve => requestAnimationFrame(resolve));
            }
            if (questionMain) {
                questionMain.innerHTML = '';
            }
            if (questionIntro) {
                questionIntro.innerHTML = '';
                questionIntro.style.display = 'none';
            }
            if (questionComment) {
                questionComment.innerHTML = '';
                questionComment.style.display = 'none';
            }
            if (questionNumber) {
                questionNumber.innerHTML = '';
            }
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                optionsContainer.style.display = 'none';
            }
            
            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã«å°‘ã—å¾…ã¤
            await new Promise(resolve => requestAnimationFrame(resolve));
            await new Promise(resolve => requestAnimationFrame(resolve));
            
            currentQuestionNumber++;
            await startFixedQuiz(currentQuestionNumber);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†æœ‰åŠ¹åŒ–ï¼ˆstartFixedQuizå†…ã§è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
            if (questionElement) {
                questionElement.style.animation = '';
            }
        }
        
        // å›ºå®šã‚¯ã‚¤ã‚ºã‚’çµ‚äº†
        async function endFixedQuiz() {
            isFixedQuizMode = false;
            currentQuestionNumber = 0;
            
            // æŠ•ç¥¨ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
            if (currentVoteListener) {
                if (currentQuestionNumber >= 1 && currentQuestionNumber <= 10) {
                    database.ref(`quizzes/current/questions/${currentQuestionNumber}/votes`).off('value', currentVoteListener);
                    database.ref(`quizzes/current/questions/${currentQuestionNumber}/totalVotes`).off('value', currentVoteListener);
                }
                currentVoteListener = null;
            }
            
            // ã‚¯ã‚¤ã‚ºéŸ³æ¥½ã‚’åœæ­¢ã—ã€ãƒãƒ£ãƒƒãƒˆéŸ³æ¥½ã‚’å†é–‹
            stopQuizMusic();
            
            closeQuiz();
            
            // Firebaseã®ã‚¯ã‚¤ã‚ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’çµ‚äº†ã«æ›´æ–°
            try {
                const quizRef = database.ref('quizzes/current');
                // currentQuestionã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ã€statusã‚’æ›´æ–°
                await quizRef.child('currentQuestion').remove();
                await quizRef.update({
                    status: 'ended',
                    endedAt: firebase.database.ServerValue.TIMESTAMP
                });
            } catch (error) {
                console.error('Firebaseæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            // çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤º
            addMessage(`å…¨${fixedQuizQuestions.length}å•çµ‚äº†ã—ã¾ã—ãŸï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼`, 'bot');
        }

        // å›ç­”ã‚’Difyã«é€ä¿¡ï¼ˆåˆ¤å®šçµæœã‚’å—ã‘å–ã‚‹ï¼‰
        async function sendQuizAnswer(selectedAnswer) {
            // ã‚¯ã‚¤ã‚ºã‚’é–‰ã˜ã‚‹
            closeQuiz();
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤º
            addMessage(`é¸æŠã—ãŸç­”ãˆ: ${selectedAnswer}`, 'user');
            
            // Difyã«å›ç­”ã‚’é€ä¿¡
            const loadingId = addMessage('è€ƒãˆä¸­...', 'bot', true);
            
            try {
                const payload = {
                    inputs: {},
                    query: selectedAnswer,
                    response_mode: "blocking",
                    user: "guest-user",
                    files: []
                };
                
                if (currentConversationId) {
                    payload.conversation_id = currentConversationId;
                }
                
                const response = await fetch(`${BASE_URL}/chat-messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.conversation_id) {
                    currentConversationId = data.conversation_id;
                }
                
                const loadingMsg = document.getElementById(loadingId);
                if(loadingMsg) loadingMsg.remove();
                
                const aiResponse = data.answer;
                
                // å›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ä¸­ã®å ´åˆã€æ¬¡ã®å•é¡ŒãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (isFixedQuizMode) {
                    // æ¬¡ã®å•é¡Œã‚’æ¤œå‡º
                    const nextQuizData = detectQuiz(aiResponse);
                    
                    if (nextQuizData) {
                        // æ¬¡ã®å•é¡ŒãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
                        currentQuestionNumber++;
                        
                        // åˆ¤å®šã¨è§£èª¬ã‚’å…ˆã«è¡¨ç¤º
                        const answerData = parseAnswerResponse(aiResponse);
                        if (answerData) {
                            // æ­£è§£ã¨è§£èª¬ã‚’ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦è¡¨ç¤º
                            addAnswerCard(answerData);
                        } else {
                            // é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦è¡¨ç¤º
                            addMessage(aiResponse, 'bot');
                        }
                        
                        // æ¬¡ã®å•é¡Œã‚’ç›´æ¥å…¨ç”»é¢è¡¨ç¤º
                        setTimeout(() => {
                            startQuiz(nextQuizData);
                        }, 1000);
                    } else {
                        // æ¬¡ã®å•é¡ŒãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆï¼ˆå…¨å•çµ‚äº†ã®å¯èƒ½æ€§ï¼‰
                        if (aiResponse.includes(`å…¨${fixedQuizQuestions.length}å•çµ‚äº†`) || aiResponse.includes('ãŠç–²ã‚Œæ§˜ã§ã—ãŸ')) {
                            isFixedQuizMode = false;
                            currentQuestionNumber = 0;
                        }
                        
                        // åˆ¤å®šã¨è§£èª¬ã‚’è¡¨ç¤º
                        const answerData = parseAnswerResponse(aiResponse);
                        if (answerData) {
                            addAnswerCard(answerData);
                        } else {
                            addMessage(aiResponse, 'bot');
                        }
                    }
                } else {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
                    // Difyã‹ã‚‰ã®å›ç­”ã‚’è§£æï¼ˆæ­£è§£ã€è§£èª¬ã‚’æŠ½å‡ºï¼‰
                    const answerData = parseAnswerResponse(aiResponse);
                    
                    if (answerData) {
                        // æ­£è§£ã¨è§£èª¬ã‚’ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦è¡¨ç¤º
                        addAnswerCard(answerData);
                    } else {
                        // é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦è¡¨ç¤º
                        addMessage(aiResponse, 'bot');
                    }
                }
                
            } catch (error) {
                console.error(error);
                const loadingMsg = document.getElementById(loadingId);
                if(loadingMsg) loadingMsg.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒãªã©ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            }
        }
        
        // Difyã‹ã‚‰ã®å›ç­”ã‚’è§£æï¼ˆæ­£è§£ã¨è§£èª¬ã‚’æŠ½å‡ºï¼‰
        function parseAnswerResponse(text) {
            const normalizedText = text.replace(/<br\s*\/?>/gi, '\n').replace(/&nbsp;/g, ' ');
            
            // åˆ¤å®šã‚’æ¤œå‡º
            const judgmentPattern = /åˆ¤å®š[:ï¼š]\s*(.+?)(?:\n|$)/i;
            const judgmentMatch = normalizedText.match(judgmentPattern);
            const judgment = judgmentMatch ? judgmentMatch[1].trim() : '';
            
            // æ­£è§£ã‚’æ¤œå‡º
            const answerPattern = /æ­£è§£[:ï¼š]\s*([A-D])/i;
            const answerMatch = normalizedText.match(answerPattern);
            const correctAnswer = answerMatch ? answerMatch[1].toUpperCase() : null;
            
            // è§£èª¬ã‚’æ¤œå‡º
            const explanationPattern = /è§£èª¬[:ï¼š]\s*(.+?)(?:\n\n|$)/is;
            const explanationMatch = normalizedText.match(explanationPattern);
            let explanation = '';
            if (explanationMatch) {
                explanation = explanationMatch[1].trim()
                    .replace(/\n+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .replace(/<br\s*\/?>/gi, ' ');
            }
            
            if (judgment || correctAnswer || explanation) {
                return {
                    judgment: judgment,
                    correctAnswer: correctAnswer,
                    explanation: explanation,
                    fullText: text
                };
            }
            
            return null;
        }
        
        // æ­£è§£ã¨è§£èª¬ã‚’ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦è¡¨ç¤º
        function addAnswerCard(answerData) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = 'message bot';
            
            // å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆå…¨ç”»é¢è¡¨ç¤ºæ™‚ã«ä½¿ç”¨ï¼‰
            const answerId = 'answer-' + Date.now();
            div.dataset.answerId = answerId;
            window[answerId] = answerData;
            
            // ãƒãƒ£ãƒƒãƒˆç”»é¢ã§ã¯åˆ¤å®šçµæœã‚’è¡¨ç¤ºã›ãšã€å…¨ç”»é¢è¡¨ç¤ºæ™‚ã«ã®ã¿è¡¨ç¤º
            div.innerHTML = `
                <div class="message-text">
                    <div class="quiz-card" onclick="showAnswer('${answerId}')">
                        <h3>âœ… æ­£è§£ã¯ã“ã¡ã‚‰ï¼</h3>
                        <p>çµæœã‚’ç¢ºèªã™ã‚‹</p>
                        <button>å…¨ç”»é¢ã§è¡¨ç¤ºã™ã‚‹</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        // å…¨ç”»é¢ã§æ­£è§£ã¨è§£èª¬ã‚’è¡¨ç¤ºï¼ˆãƒ‘ãƒãƒ«ã§ã¯ãªãé€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰
        function showAnswer(answerId) {
            const answerData = window[answerId];
            if (!answerData) return;
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
            const overlay = document.getElementById('quiz-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('show'), 10);
            
            // åˆ¤å®šã‚’è¡¨ç¤ºï¼ˆå•é¡Œã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨ï¼‰
            const questionWrapper = document.getElementById('quiz-question-wrapper');
            const questionIntro = document.getElementById('quiz-question-intro');
            const questionMain = document.getElementById('quiz-question-main');
            const questionComment = document.getElementById('quiz-question-comment');
            const timerElement = document.getElementById('quiz-timer');
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’éè¡¨ç¤º
            if (timerElement) {
                timerElement.style.display = 'none';
            }
            
            // å‰å£ä¸Šã‚’éè¡¨ç¤º
            if (questionIntro) {
                questionIntro.style.display = 'none';
            }
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã‚’éè¡¨ç¤º
            if (questionComment) {
                questionComment.style.display = 'none';
            }
            
            // åˆ¤å®šã‚’å•é¡Œæ–‡ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
            if (questionMain) {
                const safeJudgment = answerData.judgment
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/&lt;br\s*\/?&gt;/gi, '<br>')
                    .replace(/\n/g, '<br>');
                questionMain.innerHTML = safeJudgment || 'çµæœ';
            }
            
            // é¸æŠè‚¢ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            optionsContainer.style.display = 'none';
            
            // æ­£è§£ã‚’è¡¨ç¤ºï¼ˆé€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã€ãƒ‘ãƒãƒ«è¡¨ç¤ºã§ã¯ãªã„ï¼‰
            const feedbackDiv = document.getElementById('quiz-feedback');
            if (answerData.correctAnswer) {
                feedbackDiv.innerHTML = `<strong>æ­£è§£ï¼š</strong>${answerData.correctAnswer}`;
                feedbackDiv.className = 'correct';
                feedbackDiv.style.display = 'block';
            } else {
                feedbackDiv.innerHTML = '';
                feedbackDiv.className = '';
            }
            
            // è§£èª¬ã‚’è¡¨ç¤ºï¼ˆé€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã€ãƒ‘ãƒãƒ«è¡¨ç¤ºã§ã¯ãªã„ï¼‰
            const explanationDiv = document.getElementById('quiz-explanation');
            if (answerData.explanation) {
                const safeExplanation = answerData.explanation
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/&lt;br\s*\/?&gt;/gi, '<br>')
                    .replace(/\n/g, '<br>');
                explanationDiv.innerHTML = `<strong>è§£èª¬ï¼š</strong>${safeExplanation}`;
                explanationDiv.style.display = 'block';
            } else {
                explanationDiv.innerHTML = '';
            }
            
            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã¿è¡¨ç¤º
            const actionsDiv = document.getElementById('quiz-actions');
            actionsDiv.innerHTML = '';
            actionsDiv.style.display = 'flex'; // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³è¡¨ç¤ºæ™‚ã«è¡¨ç¤º
            const closeBtn = document.createElement('button');
            closeBtn.className = 'quiz-action-btn';
            closeBtn.textContent = 'é–‰ã˜ã‚‹';
            closeBtn.onclick = function() {
                closeQuiz();
            };
            actionsDiv.appendChild(closeBtn);
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
        function startTimer() {
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (quizTimer) {
                clearInterval(quizTimer);
            }
            
            const timerElement = document.getElementById('quiz-timer');
            timeRemaining = 60;
            timerElement.textContent = timeRemaining;
            timerElement.classList.remove('warning');
            
            quizTimer = setInterval(() => {
                timeRemaining--;
                timerElement.textContent = timeRemaining;
                
                // 10ç§’ä»¥ä¸‹ã«ãªã£ãŸã‚‰è­¦å‘Šè¡¨ç¤º
                if (timeRemaining <= 10) {
                    timerElement.classList.add('warning');
                }
                
                // æ™‚é–“åˆ‡ã‚Œ
                if (timeRemaining <= 0) {
                    clearInterval(quizTimer);
                    timerElement.textContent = 'TIME UP!';
                    // è‡ªå‹•çš„ã«æœ€åˆã®é¸æŠè‚¢ã‚’é¸æŠï¼ˆã¾ãŸã¯ä½•ã‚‚ã—ãªã„ï¼‰
                    // ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
                }
            }, 1000);
        }
        
        // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
        function stopTimer() {
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
        }
        
        async function closeQuiz() {
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
            stopTimer();
            
            // ã‚¯ã‚¤ã‚ºéŸ³æ¥½ã‚’åœæ­¢ã—ã€ãƒãƒ£ãƒƒãƒˆéŸ³æ¥½ã‚’å†é–‹
            stopQuizMusic();
            
            // å›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ä¸­ã«é–‰ã˜ãŸå ´åˆã€Firebaseã®çŠ¶æ…‹ã‚’æ›´æ–°
            if (isFixedQuizMode && currentQuestionNumber >= 1 && currentQuestionNumber <= 10) {
                try {
                    const quizRef = database.ref('quizzes/current');
                    // currentQuestionã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ã€statusã‚’æ›´æ–°
                    await quizRef.child('currentQuestion').remove();
                    await quizRef.update({
                        status: 'ended',
                        endedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    // å›ºå®šã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
                    isFixedQuizMode = false;
                    currentQuestionNumber = 0;
                } catch (error) {
                    console.error('Firebaseæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            const overlay = document.getElementById('quiz-overlay');
            overlay.classList.remove('show');
            setTimeout(() => {
                overlay.style.display = 'none';
                // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                quizAnswered = false;
                currentQuizData = null;
                timeRemaining = 60;
                const timerElement = document.getElementById('quiz-timer');
                if (timerElement) {
                    timerElement.textContent = timeRemaining;
                    timerElement.classList.remove('warning');
                }
            }, 300);
        }
        // ===== éŸ³æ¥½æ©Ÿèƒ½ =====
        let backgroundMusic = null;
        let quizMusic = null;
        let isMusicPlaying = false;
        let wasMusicPlayingBeforeQuiz = false; // ã‚¯ã‚¤ã‚ºé–‹å§‹å‰ã®éŸ³æ¥½å†ç”ŸçŠ¶æ…‹ã‚’è¨˜éŒ²

        function initMusic() {
            backgroundMusic = new Audio('assets/music0.m4a');
            backgroundMusic.volume = 0.5;
            backgroundMusic.loop = true;
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯offãªã®ã§ã€åˆæœŸåŒ–ã®ã¿
        }

        function initQuizMusic() {
            if (!quizMusic) {
                quizMusic = new Audio('assets/music1.m4a');
                quizMusic.volume = 0.5;
                quizMusic.loop = true;
            }
        }

        function toggleMusic() {
            // ã‚¯ã‚¤ã‚ºä¸­ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            const isQuizActive = isFixedQuizMode && currentQuestionNumber >= 1 && currentQuestionNumber <= 10;
            
            if (isQuizActive) {
                // ã‚¯ã‚¤ã‚ºä¸­ï¼šmusic1ã‚’åˆ¶å¾¡
                if (!quizMusic) {
                    initQuizMusic();
                }
                
                // å®Ÿéš›ã®å†ç”ŸçŠ¶æ…‹ã‚’ç¢ºèª
                if (quizMusic && !quizMusic.paused) {
                    quizMusic.pause();
                    isMusicPlaying = false;
                } else {
                    quizMusic.play().catch(e => {
                        console.log('ã‚¯ã‚¤ã‚ºéŸ³æ¥½ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                    });
                    isMusicPlaying = true;
                }
            } else {
                // ãƒãƒ£ãƒƒãƒˆç”»é¢ï¼šmusic0ã‚’åˆ¶å¾¡ï¼ˆã‚¯ã‚¤ã‚ºéŸ³æ¥½ãŒå†ç”Ÿä¸­ã§ã‚‚åœæ­¢ã™ã‚‹ï¼‰
                if (quizMusic && !quizMusic.paused) {
                    quizMusic.pause();
                    quizMusic.currentTime = 0;
                }
                
                if (!backgroundMusic) {
                    initMusic();
                }
                
                // å®Ÿéš›ã®å†ç”ŸçŠ¶æ…‹ã‚’ç¢ºèª
                if (backgroundMusic && !backgroundMusic.paused) {
                    backgroundMusic.pause();
                    isMusicPlaying = false;
                } else {
                    backgroundMusic.play().catch(e => {
                        console.log('éŸ³æ¥½ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                    });
                    isMusicPlaying = true;
                }
            }
            updateMusicButtonState();
        }

        function startQuizMusic() {
            // ã‚¯ã‚¤ã‚ºé–‹å§‹æ™‚ï¼šmusic0ã‚’åœæ­¢ã—ã€music1ã‚’å†ç”Ÿ
            wasMusicPlayingBeforeQuiz = isMusicPlaying;
            
            if (backgroundMusic && !backgroundMusic.paused) {
                backgroundMusic.pause();
            }
            
            initQuizMusic();
            if (wasMusicPlayingBeforeQuiz) {
                quizMusic.play().catch(e => {
                    console.log('ã‚¯ã‚¤ã‚ºéŸ³æ¥½ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                });
                isMusicPlaying = true;
            } else {
                isMusicPlaying = false;
            }
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆã‚¯ã‚¤ã‚ºéŸ³æ¥½ã®çŠ¶æ…‹ã‚’åæ˜ ï¼‰
            updateMusicButtonState();
        }

        function stopQuizMusic() {
            // ã‚¯ã‚¤ã‚ºçµ‚äº†æ™‚ï¼šmusic1ã‚’åœæ­¢ã—ã€music0ã‚’å†é–‹ï¼ˆå…ƒã€…å†ç”Ÿã—ã¦ã„ãŸå ´åˆï¼‰
            if (quizMusic && !quizMusic.paused) {
                quizMusic.pause();
                quizMusic.currentTime = 0;
            }
            
            // ãƒãƒ£ãƒƒãƒˆç”»é¢ã«æˆ»ã£ãŸã®ã§ã€music0ã®çŠ¶æ…‹ã«åˆã‚ã›ã‚‹
            if (wasMusicPlayingBeforeQuiz && backgroundMusic) {
                backgroundMusic.play().catch(e => {
                    console.log('éŸ³æ¥½ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                });
                isMusicPlaying = true;
            } else {
                isMusicPlaying = false;
            }
            
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆãƒãƒ£ãƒƒãƒˆéŸ³æ¥½ã®çŠ¶æ…‹ã‚’åæ˜ ï¼‰
            updateMusicButtonState();
        }

        function updateMusicButtonState() {
            const button = document.getElementById('music-toggle');
            // ã‚¯ã‚¤ã‚ºä¸­ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            const isQuizActive = isFixedQuizMode && currentQuestionNumber >= 1 && currentQuestionNumber <= 10;
            
            if (isQuizActive) {
                // ã‚¯ã‚¤ã‚ºä¸­ï¼šquizMusicã®çŠ¶æ…‹ã‚’ç¢ºèª
                if (quizMusic && !quizMusic.paused) {
                    button.textContent = 'ğŸ”Š';
                    button.classList.remove('muted');
                } else {
                    button.textContent = 'ğŸ”‡';
                    button.classList.add('muted');
                }
            } else {
                // ãƒãƒ£ãƒƒãƒˆç”»é¢ï¼šbackgroundMusicã®çŠ¶æ…‹ã‚’ç¢ºèª
                if (backgroundMusic && !backgroundMusic.paused) {
                    button.textContent = 'ğŸ”Š';
                    button.classList.remove('muted');
                } else {
                    button.textContent = 'ğŸ”‡';
                    button.classList.add('muted');
                }
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«éŸ³æ¥½ã‚’åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯offï¼‰
        window.addEventListener('load', () => {
            initMusic();
            updateMusicButtonState();
        });

        // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹ã¨ãã«éŸ³æ¥½ã‚’åœæ­¢
        window.addEventListener('beforeunload', () => {
            if (backgroundMusic) {
                backgroundMusic.pause();
            }
        });

    </script>
</body>
</html>